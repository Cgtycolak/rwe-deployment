{% extends 'base.html' %} {% block body %}
<style>
  .btn_vsm {
    font-size: 0.55rem;
    line-height: 0.7 !important;
    padding: 4px;
    border-radius: 50% !important;
  }
  .lh_0 {
    line-height: 0px;
  }
  .mxh_112 {
    max-height: 112px !important;
    overflow: auto !important;
  }
  .h_80vh {
    height: 80vh;
  }
  .wait_text {
    font-weight: bold;
    text-shadow: 2px 2px 4px #000000;
    color: white;
    font-size: 1.2rem;
  }
  .bg1 {
    background: #2d3436 !important;
  }
  .mxw_precent_100 {
    max-width: 100% !important;
  }
  .dynamic_table_cont {
    max-height: 80vh !important;
  }
  .cont_overflow_99 {
    max-width: 99% !important;
    overflow: auto;
  }
  .switch_arg {
    display: none;
  }
  .switch_arg.active {
    display: block;
  }
  .switch_arg[data-switch="fuel_types_chart"] #dpp_chart_btns {
    display: none !important;
  }

  /* Compact table styles for all tables */
  .table {
    font-size: 0.85rem;
  }

  .table th,
  .table td {
    padding: 0.3rem !important;
    white-space: nowrap;
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .table thead {
    position: sticky;
    top: 0;
    z-index: 1;
    background: #2d3436 !important;
    opacity: 0.95;
  }

  .table th {
    font-weight: 500;
    color: white;
  }

  /* Add tooltip on hover for truncated text */
  .table td[title],
  .table th[title] {
    cursor: help;
  }

  /* Day header styling */
  .day-header {
    font-size: 0.9rem;
    padding: 0.4rem !important;
    background: mintcream !important;
    font-weight: 500;
  }

  /* Organization name styling */
  .org-name {
    font-weight: 500;
  }

  /* Adjust table container heights */
  .dynamic_table_cont {
    max-height: 75vh !important;
  }

  .option-checkbox {
    vertical-align: middle;
    margin-right: 5px;
  }

  select option {
    padding: 5px;
    display: flex;
    align-items: center;
  }

  /* Specific styling for table headers */
  .table-dark {
    background-color: #2d3436 !important;
    border-color: #2d3436 !important;
  }

  .table-dark th {
    background-color: #2d3436 !important;
    border-color: #2d3436 !important;
  }

  /* Add these new styles */
  .btn-group {
    display: flex;
    justify-content: center;
    margin-bottom: 1rem;
  }

  .switch_selector, .btn[data-switch] {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
  }

  .switch_selector i, .btn[data-switch] i {
    font-size: 1rem;
  }

  /* Fix button container alignment */
  .d-flex.justify-content-start.align-items-center.p-2.border.mx-2.shadow {
    justify-content: center !important;
  }

  /* Add these styles to your existing style block */
  .switch_arg[data-switch="realtime_difference"] {
    position: relative;
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
    overflow: hidden;
  }

  #difference_chart {
    position: relative;
    width: 100% !important;
    max-width: none !important;
    margin: 0 auto !important;
    padding: 0 !important;
  }

  /* Container adjustments */
  .container-fluid {
    max-width: 100% !important;
    overflow-x: hidden !important;
  }

  /* Ensure the parent containers don't add unwanted margins */
  .table_args[data-table="realtime"],
  .realtime_options,
  .switch_arg {
    margin: 0 !important;
    padding: 0 !important;
    max-width: 100% !important;
    overflow-x: hidden !important;
  }

  .difference-chart-container {
    width: 95%;
    height: 85vh;
    margin: 0 auto;
    padding: 20px;
  }

  #difference_chart {
    width: 100%;
    height: 100%;
  }

  /* Remove any previous conflicting styles */
  .switch_arg[data-switch="realtime_difference"] {
    width: 100% !important;
    overflow: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* Add these styles */
  .content-section[data-section="generation-comparison"] {
    padding: 20px;
    background: white;
  }

  .switch_arg[data-group="comparison_view"] {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  #comparison_loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255,255,255,0.9);
    padding: 20px;
    border-radius: 8px;
    z-index: 1000;
    text-align: center;
  }

  .table-responsive {
    position: relative;
    min-height: 200px;
  }

  /* Add specific styles for AIC section */
  .content-section[data-section="aic-realtime"] {
    padding: 20px;
    background: white;
  }

  .aic-range-btn.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
  }

  /* Add these styles to your existing CSS */
  .table td {
    transition: all 0.2s ease-in-out;
  }

  .table td:hover {
    opacity: 0.8;
  }

  /* Make the table more modern */
  .table {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
  }

  .table thead th {
    background-color: #2d3436 !important;
    color: white !important;
    font-weight: 500;
    text-transform: uppercase;
    font-size: 0.9rem;
    letter-spacing: 0.5px;
    border: 1px solid rgba(0, 0, 0, 0.2) !important;
  }

  .table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
  }

  .table td {
    padding: 12px;
    vertical-align: middle;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
  }

  /* Add styles for differences table */
  #comparison_differences_table thead th {
    background-color: #2d3436 !important;
    color: white !important;
  }

  /* Consistent table header colors */
  .table-primary th, .table-success th, .table-dark th {
    background-color: #2d3436 !important;
    color: white !important;
    border-color: rgba(0, 0, 0, 0.2) !important;
  }

  /* Add grid lines */
  .table-bordered {
    border: 1px solid rgba(0, 0, 0, 0.2);
  }

  .table-bordered th,
  .table-bordered td {
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
  }

  /* Improve cell hover effect */
  .table td:hover {
    opacity: 0.9;
    transition: all 0.2s ease;
  }

  /* Add to your existing styles */
  #load_comparison_data {
    min-width: 120px;  /* Prevent button size change during loading */
    position: relative;
  }

  #load_comparison_data .loading-state {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  #load_comparison_data:disabled {
    cursor: not-allowed;
    opacity: 0.8;
  }

  .spinner-border-sm {
    width: 1rem;
    height: 1rem;
    border-width: 0.15em;
  }

  /* Update existing styles */
  .table thead th,
  .table-primary thead th,
  .table-success thead th,
  .table-dark thead th,
  .table thead.table-primary,
  .table thead.table-success,
  .table thead.table-dark {
    background-color: #2d3436 !important;
    color: white !important;
    border-color: #2d3436 !important;
  }

  /* Ensure all table headers have the same styling */
  .table-primary,
  .table-success,
  .table-dark {
    --bs-table-bg: #2d3436 !important;
    --bs-table-striped-bg: #2d3436 !important;
    --bs-table-active-bg: #2d3436 !important;
    --bs-table-hover-bg: #2d3436 !important;
    border-color: #2d3436 !important;
    color: white !important;
  }

  /* Override any Bootstrap default styles */
  .table > :not(caption) > * > * {
    background-color: var(--bs-table-bg);
  }

  /* Ensure header opacity is consistent */
  .table thead {
    background: #2d3436 !important;
    opacity: 1 !important;
  }

  /* Add to your existing styles */
  .home-link {
    color: var(--text-light);
    text-decoration: none;
    font-size: 1.2rem;
  }

  .home-link:hover {
    color: var(--hover-color);
    text-decoration: none;
  }

  /* Add this to your content section styles */
  .content-section[data-section="home"] {
    text-align: center;
    padding: 40px;
  }

  .welcome-section {
    max-width: 1400px;
    margin: 0 auto;
  }

  .dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 40px;
  }

  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-5px);
  }

  .quick-links {
    margin-top: 40px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
  }

  .quick-link-card {
    background: var(--primary-color);
    color: var(--text-light);
    padding: 20px;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .quick-link-card:hover {
    background: var(--hover-color);
    transform: translateY(-5px);
  }

  /* Load all font weights and styles */
  @font-face {
    font-family: 'RWE Sans Web';
    src: url("{{ url_for('static', filename='fonts/rwe-sans-web/RWE Sans Web.otf') }}") format('opentype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
  }
  
  @font-face {
    font-family: 'RWE Sans Web';
    src: url("{{ url_for('static', filename='fonts/rwe-sans-web/RWE Sans Web Bold.otf') }}") format('opentype');
    font-weight: bold;
    font-style: normal;
    font-display: swap;
  }

  /* Update the chart container CSS */
  .content-section[data-section="rolling-averages"] .chart-container {
    margin-bottom: 2rem;
    padding: 0;
    background: transparent;
    height: 480px;  /* Reduced height */
    width: 100%;
    max-width: 100%;
    position: relative;
    margin: 0 auto;
    aspect-ratio: 16 / 9;  /* Force a widescreen aspect ratio */
  }

  /* Add responsive container for charts */
  .content-section[data-section="rolling-averages"] .col-md-6 {
    padding: 0 15px;
  }

  /* Adjust chart title position at different zoom levels */
  @media screen and (min-width: 1200px) {
    .content-section[data-section="rolling-averages"] .gtitle {
      transform: translateX(-20px);
    }
  }

  .content-section[data-section="rolling-averages"] h2 {
    font-family: 'RWE Sans Web', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    font-weight: normal;
    color: #2c3e50;
  }

  /* Force Plotly to use our font */
  .content-section[data-section="rolling-averages"] .js-plotly-plot .plotly .main-svg text {
    font-family: 'RWE Sans Web', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif !important;
  }
  
  /* Ensure title uses correct font */
  .content-section[data-section="rolling-averages"] .gtitle {
    font-family: 'RWE Sans Web', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif !important;
    font-weight: normal !important;
  }
  
  /* Move modebar to bottom of chart */
  .content-section[data-section="rolling-averages"] .js-plotly-plot .plotly .modebar {
    top: auto !important;
    bottom: 0 !important;
    right: 0 !important;
    background-color: rgba(255, 255, 255, 0.7);
    border-radius: 4px;
  }
  
  /* Option to hide modebar completely */
  .content-section[data-section="rolling-averages"] .hide-modebar .js-plotly-plot .plotly .modebar {
    display: none !important;
  }
  
  /* Debug info */
  .content-section[data-section="rolling-averages"] #debug-data {
    font-family: monospace;
    white-space: pre;
    font-size: 12px;
    margin-top: 20px;
    padding: 10px;
    background: #f5f5f5;
    border-radius: 4px;
    display: none;
  }
  
  .content-section[data-section="rolling-averages"] #loading {
    text-align: center;
    padding: 20px;
  }
  
  /* Controls for all charts */
  .content-section[data-section="rolling-averages"] .chart-controls {
    margin-bottom: 20px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
  }

  /* Tab styling */
  #forecastingTabs .nav-link {
    color: #495057;
    background-color: #f8f9fa;
    border-color: #dee2e6 #dee2e6 #fff;
    transition: all 0.2s ease-in-out;
  }
  
  #forecastingTabs .nav-link:hover {
    color: #007bff;
    background-color: #e9ecef;
    border-color: #dee2e6 #dee2e6 #e9ecef;
  }
  
  #forecastingTabs .nav-link.active {
    color: #fff;
    background-color: #007bff;
    border-color: #007bff;
    font-weight: 500;
  }
  
  /* Add a subtle indicator for the active tab */
  #forecastingTabs .nav-link.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
    height: 3px;
    background-color: #007bff;
  }
  
  /* Make tabs more responsive */
  @media (max-width: 768px) {
    #forecastingTabs .nav-link {
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
    }
  }

  /* Forecast Performance specific styles */
  .content-section[data-section="forecast-performance"] {
    padding: 20px;
    background: white;
  }

  .content-section[data-section="forecast-performance"] .metric-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .content-section[data-section="forecast-performance"] .metric-item:last-child {
    margin-bottom: 0;
  }

  .content-section[data-section="forecast-performance"] .card-body {
    padding: 1rem;
  }

  .content-section[data-section="forecast-performance"] .card-header h6 {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 600;
  }

  /* Loading spinner for forecast performance */
  #performance_loading {
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  /* Forecast Performance Styling */
  #performance_metrics .card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
  }
  
  #performance_metrics .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .metric-item {
    padding: 2px 0;
  }
  
  .badge {
    font-size: 0.85em;
    padding: 0.5em 0.75em;
    border-radius: 0.5rem;
  }
  
  /* Smooth gradient backgrounds for metric cards */
  .bg-gradient {
    background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
  }
  
  /* Custom form styling for forecast performance */
  .content-section[data-section="forecast-performance"] .form-select,
  .content-section[data-section="forecast-performance"] .form-control {
    border: 1px solid #e0e0e0;
    border-radius: 0.5rem;
    transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
  }
  
  .content-section[data-section="forecast-performance"] .form-select:focus,
  .content-section[data-section="forecast-performance"] .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }
  
  /* Chart container styling */
  #forecast_performance_chart {
    border-radius: 0.5rem;
    background: white;
  }
  
  /* Loading spinner styling */
  #performance_loading {
    padding: 3rem 0;
  }
  
  /* Info alert styling */
  .content-section[data-section="forecast-performance"] .alert-info {
    background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
    border: 1px solid #bbdefb;
    border-radius: 0.5rem;
  }
  
  /* Button styling enhancements */
  .content-section[data-section="forecast-performance"] .btn {
    border-radius: 0.5rem;
    transition: all 0.2s ease-in-out;
  }
  
  .content-section[data-section="forecast-performance"] .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
</style>

<div class="container-fluid">
    <!-- Add this as the first content section -->
    <div class="content-section" data-section="home">
        <div class="welcome-section">
            <h1 class="mb-4">Welcome to RWE Dashboard</h1>
            <p class="lead">Your comprehensive power plant monitoring and analysis platform</p>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <i class="fas fa-bolt mb-3" style="font-size: 2rem; color: #3498db;"></i>
                    <h3>Real-time Monitoring</h3>
                    <p>Track power generation and performance metrics in real-time</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-chart-line mb-3" style="font-size: 2rem; color: #2ecc71;"></i>
                    <h3>Data Analysis</h3>
                    <p>Comprehensive analysis tools for generation data</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-fire mb-3" style="font-size: 2rem; color: #e74c3c;"></i>
                    <h3>Heatmap Reports</h3>
                    <p>Visualize generation patterns and trends</p>
                </div>
            </div>

            <div class="quick-links">
                <a href="#" class="quick-link-card" data-section="kgup-realtime">
                    <i class="fas fa-bolt mb-2"></i>
                    <h4>DPP - Realtime</h4>
                    <p>Monitor Planned Generation, Realtime Generation and the Difference between them</p>
                </a>
                <a href="#" class="quick-link-card" data-section="generation-comparison">
                    <i class="fas fa-chart-bar mb-2"></i>
                    <h4>Generation Comparison</h4>
                    <p>Compare generation across fuel types</p>
                </a>
                <a href="#" class="quick-link-card" data-section="generation-heatmap">
                    <i class="fas fa-fire mb-2"></i>
                    <h4>DPP Heatmap</h4>
                    <p>View Planned/Realtime Generation Heatmaps of the top 20 Natural GasPower Plants</p>
                </a>
            </div>

             <div class="mini-tables-section">
                <div id="order-summary-table"></div>
                <div id="smp-table"></div>
                <div id="pfc-table"></div>
                <div id="sfc-table"></div>
            </div>

        </div>
    </div>

    <!-- DPP-Realtime section -->
    <div class="content-section" data-section="kgup-realtime">
        <div class="container-fluid row m-0 p-0" id="app">
            <!-- messages --->
            <div class="col-sm-12 m-0 p-0" id="alert_messages"></div>
            <!-- Aside -->
            <div class="col-sm-3 m-0 p-0 border">
                <div class="row m-0 p-0">
                    <!-- Global Args -->
                    <div class="col-sm-12 m-0 p-0">
                        <div class="border row m-0">
                            <div class="col-sm-12 p-2">
                                <label>Start Date:</label>
                                <input
                                    id="global_start"
                                    data-prop="start"
                                    value=""
                                    class="form-control"
                                    type="date"
                                />
                            </div>
                            <div class="col-sm-12 p-2">
                                <label>End Date:</label>
                                <input
                                    id="global_end"
                                    data-prop="end"
                                    value=""
                                    class="form-control"
                                    type="date"
                                />
                            </div>
                        </div>
                    </div>

                    <!-- DPP Args -->
                    <div class="col-sm-12 m-0 p-0">
                        <div class="p-2 border table_args" data-table="dpp">
                            <div class="text-center mb-2">
                                <button
                                    id="load_orgs"
                                    title="Please select start date and end date to load the organziations."
                                    class="btn btn-outline-primary btn-sm btn-block"
                                >
                                    Load Organizations
                                </button>
                            </div>
                            <div id="dpp_args" style="display: none">
                                <!-- Organization Name -->
                                <div class="mb-2 text-dark">
                                    <div
                                        class="d-flex justify-content-end flex-column border shadow p-2"
                                    >
                                        <!-- Search bar for organizations -->
                                        <div class="input-group mb-2">
                                            <input
                                                type="text"
                                                class="form-control form-control-sm"
                                                id="org_search"
                                                placeholder="Search organizations..."
                                                oninput="filterOptions('org_select', this.value)"
                                            />
                                            <div class="input-group-append">
                                                <button
                                                    class="btn btn-sm btn-outline-secondary"
                                                    type="button"
                                                >
                                                    <i class="fa fa-search"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Quick filters -->
                                        <div class="mb-2">
                                            <div class="form-check form-check-inline">
                                                <input
                                                    class="form-check-input"
                                                    type="checkbox"
                                                    id="select_all_orgs"
                                                    onchange="toggleAllOptions('org_select', this.checked)"
                                                />
                                                <label class="form-check-label small" for="select_all_orgs"
                                                    >Select All</label
                                                >
                                            </div>
                                        </div>

                                        <!-- setup look and config of html searchable select by only data-attr -->
                                        <select
                                            class="form-control"
                                            name="org"
                                            id="org_select"
                                            multiple="multiple"
                                            data-name="Organziations"
                                            data-label=""
                                            data-search-placeholder=""
                                            data-cont-style="background:lavender !important;"
                                            data-search-style=""
                                            data-search-extra-attrs="title"
                                            data-label-style=""
                                            data-counter=""
                                            data-minimizable=""
                                            data-select-checkbox=""
                                            data-select-checkbox-style=""
                                        ></select>

                                        <div class="my-2 text-center">
                                            <button
                                                id="load_uevcbids"
                                                class="btn btn-sm btn-outline-primary btn-block"
                                            >
                                                Load UEVCBIDS
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Organization End -->
                                <!-- UECVBIDS -->
                                <div class="mb-2 text-dark">
                                    <div
                                        class="d-flex justify-content-end flex-column border shadow p-2"
                                    >
                                        <!-- Add search bar for UEVCBIDS -->
                                        <div class="input-group mb-2">
                                            <input
                                                type="text"
                                                class="form-control form-control-sm"
                                                id="uevcbid_search"
                                                placeholder="Search UEVCBIDS..."
                                                oninput="filterOptions('adi_select', this.value)"
                                            />
                                            <div class="input-group-append">
                                                <button
                                                    class="btn btn-sm btn-outline-secondary"
                                                    type="button"
                                                >
                                                    <i class="fa fa-search"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="mb-2">
                                            <div class="form-check form-check-inline">
                                                <input
                                                    class="form-check-input"
                                                    type="checkbox"
                                                    id="select_all_uevcbids"
                                                    onchange="toggleAllOptions('adi_select', this.checked)"
                                                />
                                                <label
                                                    class="form-check-label small"
                                                    for="select_all_uevcbids"
                                                    >Select All</label
                                                >
                                            </div>
                                        </div>

                                        <select
                                            class="form-control"
                                            id="adi_select"
                                            multiple="multiple"
                                            data-name="UEVCBIDS"
                                            data-label=""
                                            data-search-placeholder=""
                                            data-cont-style="background:lavender !important;"
                                            data-search-style=""
                                            data-label-style=""
                                            data-counter=""
                                            data-minimizable=""
                                            data-select-checkbox=""
                                            data-select-checkbox-style=""
                                        ></select>
                                    </div>
                                </div>
                                <!-- UECVBIDS End -->

                                <!-- Display Table Step 3 -->
                                <div class="text-center mb-2">
                                    <button
                                        class="btn btn-outline-primary btn-sm btn-block"
                                        id="load_dpp"
                                        title="Recreate Table."
                                    >
                                        Display Table
                                    </button>
                                </div>

                                <div class="mb-2">
                                    <!-- note API ask for org and related UEVCBIDS -->
                                    <div
                                        id="org_filters"
                                        class="mt-2 d-flex justify-content-start align-items-start flex-wrap"
                                    ></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Realtime Args -->
                    <div class="col-sm-12 m-0 p-0">
                        <div class="p-2 border table_args" data-table="realtime">
                            <div class="text-center mb-2">
                                <button
                                    id="load_powerplants"
                                    class="btn btn-outline-primary btn-sm btn-block"
                                >
                                    Load Power Plants
                                </button>
                            </div>
                            <div id="realtime_args_content" style="display: none">
                                <!-- Power Plant Selection -->
                                <div class="mb-2 text-dark">
                                    <div
                                        class="d-flex justify-content-end flex-column border shadow p-2"
                                    >
                                        <!-- Search bar for power plants -->
                                        <div class="input-group mb-2">
                                            <input
                                                type="text"
                                                class="form-control form-control-sm"
                                                id="powerplant_search"
                                                placeholder="Search power plants..."
                                                oninput="filterOptions('powerplant_select', this.value)"
                                            />
                                            <div class="input-group-append">
                                                <button
                                                    class="btn btn-sm btn-outline-secondary"
                                                    type="button"
                                                >
                                                    <i class="fa fa-search"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Quick filters -->
                                        <div class="mb-2">
                                            <div class="form-check form-check-inline">
                                                <input
                                                    class="form-check-input"
                                                    type="checkbox"
                                                    id="select_all_plants"
                                                    onchange="toggleAllOptions('powerplant_select', this.checked)"
                                                />
                                                <label
                                                    class="form-check-label small"
                                                    for="select_all_plants"
                                                    >Select All</label
                                                >
                                            </div>
                                        </div>

                                        <select
                                            class="form-control"
                                            name="powerplant"
                                            id="powerplant_select"
                                            multiple="multiple"
                                            data-name="Power Plants"
                                            data-label=""
                                            data-search-placeholder=""
                                            data-cont-style="background:lavender !important;"
                                            data-search-style=""
                                            data-search-extra-attrs="title"
                                            data-label-style=""
                                            data-counter=""
                                            data-minimizable=""
                                            data-select-checkbox=""
                                            data-select-checkbox-style=""
                                        ></select>
                                    </div>
                                </div>

                                <!-- Display Table Button -->
                                <div class="text-center mb-2">
                                    <button
                                        class="btn btn-outline-primary btn-sm btn-block"
                                        id="load_realtime"
                                        title="Display Realtime Data"
                                    >
                                        Display Table
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Global Arg Table Filters -->
                    <div class="col-sm-12 m-0 p-0" id="table_filters"></div>
                </div>
            </div>
            <!-- Main -->
            <div class="col-sm-9 m-0 p-0 shadow">
                <!-- Dynamic Tables -->
                <div class="m-0 p-0 flex" id="tables_cont">
                    <div class="m-0 p-0 table_args" data-table="dpp">
                        <div class="m-0 p-0 dpp_options" style="display: none">
                            <div
                                class="d-flex justify-content-center align-items-center p-2 border mx-2 shadow"
                            >
                                <button
                                    class="btn btn-sm btn-outline-primary mr-1 switch_selector"
                                    title="Display day report chart for specific fuel type"
                                    data-group="dpp_nested"
                                    data-switch="fuel_types_chart"
                                >
                                    <i class="fas fa-chart-bar"></i> Chart
                                </button>
                                <button
                                    class="btn btn-sm btn-primary mr-1 switch_selector"
                                    data-group="dpp_nested"
                                    data-switch="fuel_types_table"
                                    title="Display all fuel_types reports in one table for specific fuel type"
                                >
                                    <i class="fas fa-calendar-alt"></i> Fuel Types
                                </button>
                                <button
                                    class="btn btn-sm btn-outline-primary mr-1 switch_selector"
                                    data-group="dpp_nested"
                                    data-switch="all_table"
                                    title="Display all data in one table for all fuels"
                                >
                                    <i class="fas fa-table"></i> All Data
                                </button>
                                <button
                                    class="btn btn-sm btn-outline-success ml-auto"
                                    id="download_dpp_excel"
                                    title="Download DPP data as Excel"
                                >
                                    <i class="fas fa-file-excel"></i> Import
                                </button>
                            </div>
                        </div>
                        <!-- 1 Chart for one day report for specific fuel type -->
                        <div class="m-0 p-0 dpp_options" style="display: none">
                            <div
                                class="m-0 p-0 switch_arg"
                                data-switch="fuel_types_chart"
                                data-group="dpp_nested"
                                style="display: none"
                            >
                                <div class="m-0 mx-2 p-2 row">
                                    <div class="col-sm-12 m-0 p-0">
                                        <div
                                            id="plotly_chart"
                                            style="
                                                min-height: 550px;
                                                height: 80vh;
                                                min-width: 600px;
                                                width: 100%;
                                            "
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2 table to display all selected fuel_types reports for specific fuel type -->
                        <div class="m-0 p-0 dpp_options" style="display: none">
                            <div
                                class="m-0 p-0 switch_arg"
                                data-switch="fuel_types_table"
                                data-group="dpp_nested"
                            >
                                <div id="dpp_chart_btns"></div>
                                <div
                                    id="fuel_types_report_table_cont"
                                    class="table-responsive dynamic_table_cont mx-2 cont_overflow_99"
                                >
                                    <table
                                        id="dpp_fuel_types_table"
                                        class="table table-hover table-bordered"
                                    ></table>
                                </div>
                            </div>
                        </div>

                        <!-- 3 display all data rows returned from api includes all fuels the original -->
                        <div
                            id="all_dpp_data_table_cont"
                            class="table-responsive dynamic_table_cont mx-2 cont_overflow_99 switch_arg"
                            data-switch="all_table"
                            data-group="dpp_nested"
                            style="display: none"
                        >
                            <table id="dpp_table" class="table table-hover table-bordered">
                                <thead
                                    class="table-dark"
                                    style="
                                        position: sticky;
                                        opacity: 0.8;
                                        top: 0;
                                        border: 2px solid #3069cabd;
                                    "
                                ></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Realtime table container -->
                    <div class="table_args" data-table="realtime">
                        <div class="m-0 p-0 realtime_options" style="display: none">
                            <div
                                class="d-flex justify-content-center align-items-center p-2 border mx-2 shadow"
                            >
                                <button
                                    class="btn btn-sm btn-outline-primary mr-1 switch_selector"
                                    title="Display realtime chart"
                                    data-group="realtime_nested"
                                    data-switch="realtime_chart"
                                >
                                    <i class="fas fa-chart-bar"></i> Chart
                                </button>
                                <button
                                    class="btn btn-sm btn-primary mr-1 switch_selector"
                                    data-group="realtime_nested"
                                    data-switch="realtime_fuel_types"
                                    title="Display fuel types table"
                                >
                                    <i class="fas fa-calendar-alt"></i> Fuel Types
                                </button>
                                <button
                                    class="btn btn-sm btn-outline-primary mr-1 switch_selector"
                                    data-group="realtime_nested"
                                    data-switch="realtime_all"
                                    title="Display all data"
                                >
                                    <i class="fas fa-table"></i> All Data
                                </button>
                                <button
                                    class="btn btn-sm btn-outline-primary mx-1"
                                    data-switch="realtime_difference"
                                    data-group="realtime_nested"
                                >
                                    <i class="fas fa-chart-line"></i> Difference
                                </button>
                                <button
                                    class="btn btn-sm btn-outline-success ml-auto"
                                    id="download_realtime_excel"
                                    title="Download realtime data as Excel"
                                >
                                    <i class="fas fa-file-excel"></i> Import
                                </button>
                            </div>
                        </div>

                        <!-- 1. Chart View -->
                        <div class="m-0 p-0 realtime_options" style="display: none">
                            <div
                                class="m-0 p-0 switch_arg"
                                data-switch="realtime_chart"
                                data-group="realtime_nested"
                                style="display: none"
                            >
                                <div class="m-0 mx-2 p-2 row">
                                    <div class="col-sm-12 m-0 p-0">
                                        <div
                                            id="realtime_plotly_chart"
                                            style="
                                                min-height: 550px;
                                                height: 80vh;
                                                min-width: 600px;
                                                width: 100%;
                                            "
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Fuel Types Table -->
                        <div class="m-0 p-0 realtime_options" style="display: none">
                            <div
                                class="m-0 p-0 switch_arg"
                                data-switch="realtime_fuel_types"
                                data-group="realtime_nested"
                            >
                                <div id="realtime_fuel_buttons"></div>
                                <div
                                    id="realtime_fuel_types_table_cont"
                                    class="table-responsive dynamic_table_cont mx-2 cont_overflow_99"
                                >
                                    <table
                                        id="realtime_fuel_types_table"
                                        class="table table-hover table-bordered"
                                    ></table>
                                </div>
                            </div>
                        </div>

                        <!-- 3. All Data Table -->
                        <div
                            id="realtime_all_table_cont"
                            class="table-responsive dynamic_table_cont mx-2 cont_overflow_99 switch_arg"
                            data-switch="realtime_all"
                            data-group="realtime_nested"
                            style="display: none"
                        >
                            <table id="realtime_table" class="table table-hover table-bordered">
                                <thead
                                    class="table-dark"
                                    style="
                                        position: sticky;
                                        opacity: 0.8;
                                        top: 0;
                                        border: 2px solid #3069cabd;
                                    "
                                ></thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <!-- 4. Add the Difference Chart View here -->
                        <div class="switch_arg" data-switch="realtime_difference" data-group="realtime_nested">
                            <div class="difference-chart-container">
                                <div id="difference_chart"></div>
                            </div>
                        </div>
                    </div>
                    <div
                        id="y_table_cont"
                        class="table_args table-responsive dynamic_table_cont"
                        data-table="y"
                        style="display: none"
                    >
                        3
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AIC-REALTIME-GENERATION section -->
    <div class="content-section" data-section="aic-realtime">
        <div class="container-fluid">
            <!-- Time range buttons -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-outline-primary aic-range-btn active" data-range="week">
                            <span class="button-content">
                                <i class="fas fa-calendar-week"></i> Weekly
                            </span>
                            <span class="spinner-border spinner-border-sm ms-1" role="status" style="display: none;">
                                <span class="visually-hidden">Loading...</span>
                            </span>                        
                        </button>
                        <button class="btn btn-outline-primary aic-range-btn" data-range="month">
                            <span class="button-content">
                                <i class="fas fa-calendar-alt"></i> Monthly
                            </span>
                            <span class="spinner-border spinner-border-sm ms-1" role="status" style="display: none;">
                                <span class="visually-hidden">Loading...</span>
                            </span>                        </button>
                        <button class="btn btn-outline-primary aic-range-btn" data-range="year">
<span class="button-content">
                                <i class="fas fa-calendar"></i> Yearly
                            </span>
                            <span class="spinner-border spinner-border-sm ms-1" role="status" style="display: none;">
                                <span class="visually-hidden">Loading...</span>
                            </span>
                        </button>
                        <button class="btn btn-outline-primary aic-range-btn" data-range="5year">
                            <span class="button-content">
                                <i class="fas fa-calendar-plus"></i> 5 Years
                            </span>
                            <span class="spinner-border spinner-border-sm ms-1" role="status" style="display: none;">
                                <span class="visually-hidden">Loading...</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chart container -->
            <div class="row">
                <div class="col-12">
                    <div id="aic_realtime_chart" style="width:100%; height:700px;"></div>
                </div>
            </div>

            <!-- Loading indicator -->
            <div id="aic_loading" class="text-center" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading data...</p>
            </div>
        </div>
    </div>

    <!-- Generation Comparison section -->
    <div class="content-section" data-section="generation-comparison">
        <div class="container-fluid">
            <!-- Time range buttons -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="btn-group d-flex justify-content-center" role="group">
                        <button class="btn btn-outline-primary comparison-range-btn active" data-range="daily">
                            <i class="fas fa-calendar-day"></i> Daily
                        </button>
                        <button class="btn btn-outline-primary comparison-range-btn" data-range="weekly">
                            <i class="fas fa-calendar-week"></i> Weekly
                        </button>
                        <button class="btn btn-outline-primary comparison-range-btn" data-range="monthly">
                            <i class="fas fa-calendar-alt"></i> Monthly
                        </button>
                        <button class="btn btn-outline-primary comparison-range-btn" data-range="yearly">
                            <i class="fas fa-calendar"></i> Yearly
                        </button>
                    </div>
                </div>
            </div>

            <!-- Date range selector -->
            <div class="row mb-4">
                <div class="col-md-6 offset-md-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex gap-3">
                                <div class="flex-grow-1">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="comparison_start_date">
                                    <div class="invalid-feedback">
                                        Please select a valid start date
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="comparison_end_date">
                                    <div class="invalid-feedback">
                                        Please select a valid end date
                                    </div>
                                </div>
                                <div class="d-flex align-items-end">
                                    <button class="btn btn-primary" id="load_comparison_data">
                                        <span class="normal-state">
                                            <i class="fas fa-sync"></i> Load Data
                                        </span>
                                        <span class="loading-state" style="display: none;">
                                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                            Loading...
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View switcher buttons -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-center">
                        <button class="btn btn-outline-primary mx-1 switch_selector" 
                                data-group="comparison_view" 
                                data-switch="comparison_chart">
                            <i class="fas fa-chart-line"></i> Chart
                        </button>
                        <button class="btn btn-outline-primary mx-1 switch_selector active" 
                                data-group="comparison_view" 
                                data-switch="comparison_fuel_types">
                            <i class="fas fa-table"></i> Data Tables
                        </button>
                        <button class="btn btn-outline-primary mx-1 switch_selector" 
                                data-group="comparison_view" 
                                data-switch="comparison_differences">
                            <i class="fas fa-not-equal"></i> Differences
                        </button>
                        <button class="btn btn-outline-success mx-1" id="download_comparison_excel">
                            <i class="fas fa-file-excel"></i> Import
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chart view -->
            <div class="switch_arg" data-switch="comparison_chart" data-group="comparison_view" style="display: none;">
                <div class="m-0 mx-2 p-2 row">
                    <div class="col-sm-12 m-0 p-0">
                        <div id="generation_comparison_chart" style="min-height: 550px; height: 80vh; min-width: 600px; width: 100%;"></div>
                    </div>
                </div>
            </div>

            <!-- Data Tables view -->
            <div class="switch_arg" data-switch="comparison_fuel_types" data-group="comparison_view" style="display: block;">
                <div class="row">
                    <!-- DPP Data Table -->
                    <div class="col-12 mb-4">
                        <h5 class="text-center mb-3">DPP Data</h5>
                        <div class="table-responsive dynamic_table_cont mx-2">
                            <table id="dpp_data_table" class="table table-hover table-bordered">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Date</th>
                                        <th>Hour</th>
                                        <th>Total</th>
                                        <th>Natural Gas</th>
                                        <th>Wind</th>
                                        <th>Lignite</th>
                                        <th>Import Coal</th>
                                        <th>Fuel Oil</th>
                                        <th>Geothermal</th>
                                        <th>Dammed Hydro</th>
                                        <th>Naphtha</th>
                                        <th>Biomass</th>
                                        <th>River</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="13" class="text-center">Select dates and click Load Data</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Realtime Data Table -->
                    <div class="col-12 mb-4">
                        <h5 class="text-center mb-3">Realtime Data</h5>
                        <div class="table-responsive dynamic_table_cont mx-2">
                            <table id="realtime_data_table" class="table table-hover table-bordered">
                                <thead class="table-success">
                                    <tr>
                                        <th>Date</th>
                                        <th>Hour</th>
                                        <th>Total</th>
                                        <th>Natural Gas</th>
                                        <th>Wind</th>
                                        <th>Lignite</th>
                                        <th>Import Coal</th>
                                        <th>Fuel Oil</th>
                                        <th>Geothermal</th>
                                        <th>Dammed Hydro</th>
                                        <th>Naphtha</th>
                                        <th>Biomass</th>
                                        <th>River</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="13" class="text-center">Select dates and click Load Data</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Differences view -->
            <div class="switch_arg" data-switch="comparison_differences" data-group="comparison_view" style="display: none;">
                <div id="comparison_fuel_buttons"></div>
                <div class="table-responsive dynamic_table_cont mx-2 cont_overflow_99">
                    <div id="comparison_loading" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 mb-0">Loading data...</p>
                    </div>
                    <table id="comparison_differences_table" class="table table-hover table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Date</th>
                                <th>Hour</th>
                                <th>Total</th>
                                <th>Natural Gas</th>
                                <th>Wind</th>
                                <th>Lignite</th>
                                <th>Import Coal</th>
                                <th>Fuel Oil</th>
                                <th>Geothermal</th>
                                <th>Dammed Hydro</th>
                                <th>Naphtha</th>
                                <th>Biomass</th>
                                <th>River</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="13" class="text-center">Select dates and click Load Data to view differences</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Generation Heatmap section -->
    <div class="content-section" data-section="generation-heatmap">
        <div class="container">
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="heatmap_date">Select Date:</label>
                        <input type="date" id="heatmap_date" class="form-control">
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end gap-2">
                    <button id="load_heatmap" class="btn btn-primary position-relative" style="min-width: 120px;">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <span class="button-content">Load Heatmap</span>
                    </button>
                    <button id="toggle_realtime" class="btn btn-secondary" style="min-width: 120px;" disabled>
                        Show Realtime
                    </button>
                </div>
            </div>
            <div class="row">
                <!-- Heatmap Container (initially hidden) -->
                <div id="heatmap_container" class="col-12" style="display: none;">
                    <!-- First Version Heatmap -->
                    <div class="mb-4">
                        <h5 class="text-center">Natural Gas DPP First Version</h5>
                        <div id="generation_heatmap_first_version"></div>
                    </div>
                    <!-- Current Version Heatmap -->
                    <div class="mb-4">
                        <h5 class="text-center">Natural Gas DPP Final Version</h5>
                        <div id="generation_heatmap_current"></div>
                    </div>
                    <!-- Difference Heatmap (Final - First) -->
                    <div class="mb-4">
                        <h5 class="text-center">Natural Gas DPP Difference (Final - First)</h5>
                        <div id="generation_heatmap_difference"></div>
                    </div>
                    <!-- Realtime Values -->
                    <div class="mb-4" style="display: none;">
                        <h5 class="text-center">Realtime Generation Values</h5>
                        <div id="generation_heatmap_realtime"></div>
                    </div>
                    <!-- Difference Heatmap (Realtime - Final) -->
                    <div class="mb-4" style="display: none;">
                        <h5 class="text-center">Difference (Realtime - Final)</h5>
                        <div id="generation_heatmap_realtime_difference"></div>
                    </div>
                    
                    <!-- NEW: Date Comparison Section -->
                    <div class="mb-4">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="comparison_date">Compare with Date:</label>
                                    <input type="date" id="comparison_date" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="load_comparison" class="btn btn-primary position-relative" style="min-width: 140px;">
                                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    <span class="button-content">Compare Dates</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Date Comparison Results (initially hidden) -->
                        <div id="comparison_container" style="display: none;">
                            <h5 class="text-center">Date Comparison (First Version Only)</h5>
                            <div id="generation_heatmap_date_comparison"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Coal Heatmap section -->
    <div class="content-section" data-section="import-coal-heatmap">
        <div class="container">
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="import_coal_date">Select Date:</label>
                        <input type="date" id="import_coal_date" class="form-control">
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button id="load_import_coal_heatmap" class="btn btn-primary position-relative" style="min-width: 120px;">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <span class="button-content">Load Heatmap</span>
                    </button>
                </div>
            </div>
            <div class="row">
                <div id="import_coal_heatmap_container" class="col-12" style="display: none;">
                    <!-- First Version Heatmap -->
                    <div class="mb-4">
                        <h5 class="text-center">Import Coal DPP First Version</h5>
                        <div id="import_coal_heatmap_first_version"></div>
                    </div>
                    <!-- Current Version Heatmap -->
                    <div class="mb-4">
                        <h5 class="text-center">Import Coal DPP Final Version</h5>
                        <div id="import_coal_heatmap_current"></div>
                    </div>
                    <!-- Difference Heatmap -->
                    <div class="mb-4">
                        <h5 class="text-center">Import Coal DPP Difference (Final - First)</h5>
                        <div id="import_coal_heatmap_difference"></div>
                    </div>
                    
                    <!-- NEW: Date Comparison Section -->
                    <div class="mb-4">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="import_coal_comparison_date">Compare with Date:</label>
                                    <input type="date" id="import_coal_comparison_date" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="load_import_coal_comparison" class="btn btn-primary position-relative" style="min-width: 140px;">
                                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    <span class="button-content">Compare Dates</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Date Comparison Results (initially hidden) -->
                        <div id="import_coal_comparison_container" style="display: none;">
                            <h5 class="text-center">Import Coal Date Comparison (First Version Only)</h5>
                            <div id="import_coal_heatmap_date_comparison"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lignite Heatmap section -->
    <div class="content-section" data-section="lignite-heatmap">
        <div class="container">
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="lignite_date">Select Date:</label>
                        <input type="date" id="lignite_date" class="form-control">
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end gap-2">
                    <button id="load_lignite_heatmap" class="btn btn-primary position-relative" style="min-width: 120px;">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <span class="button-content">Load Heatmap</span>
                    </button>
                    <button id="toggle_lignite_realtime" class="btn btn-secondary" style="min-width: 120px;" disabled>
                        Show Realtime
                    </button>
                </div>
            </div>
            <div class="row">
                <div id="lignite_heatmap_container" class="col-12" style="display: none;">
                    <!-- First Version Heatmap -->
                    <div class="mb-4">
                        <h5 class="text-center">Lignite DPP First Version</h5>
                        <div id="lignite_heatmap_first_version"></div>
                    </div>
                    <!-- Current Version Heatmap -->
                    <div class="mb-4">
                        <h5 class="text-center">Lignite DPP Final Version</h5>
                        <div id="lignite_heatmap_current"></div>
                    </div>
                    <!-- Difference Heatmap -->
                    <div class="mb-4">
                        <h5 class="text-center">Lignite DPP Difference (Final - First)</h5>
                        <div id="lignite_heatmap_difference"></div>
                    </div>
                    <!-- Realtime Values -->
                    <div class="mb-4" style="display: none;">
                        <h5 class="text-center">Lignite Realtime Generation Values</h5>
                        <div id="lignite_heatmap_realtime"></div>
                    </div>
                    <!-- Difference Heatmap (Realtime - Final) -->
                    <div class="mb-4" style="display: none;">
                        <h5 class="text-center">Lignite Difference (Realtime - Final)</h5>
                        <div id="lignite_heatmap_realtime_difference"></div>
                    </div>
                    
                    <!-- NEW: Date Comparison Section -->
                    <div class="mb-4">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="lignite_comparison_date">Compare with Date:</label>
                                    <input type="date" id="lignite_comparison_date" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="load_lignite_comparison" class="btn btn-primary position-relative" style="min-width: 140px;">
                                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    <span class="button-content">Compare Dates</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Date Comparison Results (initially hidden) -->
                        <div id="lignite_comparison_container" style="display: none;">
                            <h5 class="text-center">Lignite Date Comparison (First Version Only)</h5>
                            <div id="lignite_heatmap_date_comparison"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hydro Heatmap section -->
    <div class="content-section" data-section="hydro-heatmap">
        <div class="container">
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="hydro_date">Select Date:</label>
                        <input type="date" id="hydro_date" class="form-control">
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end gap-2">
                    <button id="load_hydro_heatmap" class="btn btn-primary position-relative" style="min-width: 120px;">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <span class="button-content">Load Heatmap</span>
                    </button>
                    <button id="toggle_hydro_realtime" class="btn btn-secondary" style="min-width: 120px;" disabled>
                        Show Realtime
                    </button>
                </div>
            </div>
            <div class="row">
                <div id="hydro_heatmap_container" class="col-12" style="display: none;">
                    <!-- First Version Heatmap -->
                    <div class="mb-4">
                        <h5 class="text-center">Hydro DPP First Version</h5>
                        <div id="hydro_heatmap_first_version"></div>
                    </div>
                    <!-- Current Version Heatmap -->
                    <div class="mb-4">
                        <h5 class="text-center">Hydro DPP Final Version</h5>
                        <div id="hydro_heatmap_current"></div>
                    </div>
                    <!-- Difference Heatmap -->
                    <div class="mb-4">
                        <h5 class="text-center">Hydro DPP Difference (Final - First)</h5>
                        <div id="hydro_heatmap_difference"></div>
                    </div>
                    <!-- Realtime Values -->
                    <div class="mb-4" style="display: none;">
                        <h5 class="text-center">Hydro Realtime Generation Values</h5>
                        <div id="hydro_heatmap_realtime"></div>
                    </div>
                    <!-- Difference Heatmap (Realtime - Final) -->
                    <div class="mb-4" style="display: none;">
                        <h5 class="text-center">Hydro Difference (Realtime - Final)</h5>
                        <div id="hydro_heatmap_realtime_difference"></div>
                    </div>
                    
                    <!-- NEW: Date Comparison Section -->
                    <div class="mb-4">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="hydro_comparison_date">Compare with Date:</label>
                                    <input type="date" id="hydro_comparison_date" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="load_hydro_comparison" class="btn btn-primary position-relative" style="min-width: 140px;">
                                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    <span class="button-content">Compare Dates</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Date Comparison Results (initially hidden) -->
                        <div id="hydro_comparison_container" style="display: none;">
                            <h5 class="text-center">Hydro Date Comparison (First Version Only)</h5>
                            <div id="hydro_heatmap_date_comparison"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this after the import-coal-heatmap section -->
    <div class="content-section" data-section="rolling-averages">
        <div class="container-fluid">
            <div class="chart-controls mb-4" style="background-color: white;">
                <h2 class="mb-4">Rolling Averages</h2>
                <div class="row">
                    <div class="col-md-6">
                        <button id="load-rolling-charts" class="btn btn-primary" style="min-width: 120px;">
                            <span class="button-content">Load Charts</span>
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                        <button id="toggle-modebar-all" class="btn btn-outline-secondary ms-2" style="min-width: 120px;">Hide All Chart Controls</button>
                        <button id="toggle-legends-all" class="btn btn-outline-secondary ms-2" style="min-width: 120px;">Hide All Legends</button>
                    </div>
                    <div class="col-md-6 text-end">
                        <button id="update-rolling-database" class="btn btn-outline-success" style="min-width: 120px;">
                            <span class="button-content">Update Database</span>
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                        <span id="last-update-info" class="ms-2 text-muted small"></span>
                    </div>
                </div>
            </div>
            
            <div id="loading" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading charts...</p>
            </div>

            <div id="status-message" class="alert alert-info" style="display: none;"></div>
            
            <div class="row" id="charts-container">
                <!-- Charts will be inserted here -->
            </div>
            
            <div id="debug-data"></div>
        </div>
    </div>

    <!-- Add this after the rolling-averages section -->
    <div class="content-section" data-section="forecasting">
        <div class="container-fluid">
            <h2 class="mb-4">System Direction Forecasting</h2>
            
            <div class="alert alert-warning" role="alert">
                <i class="fas fa-exclamation-triangle"></i> Reminder: Predictions after the first forecast depend on previous forecasts! They can be misleading!
            </div>
            
            <!-- File Upload Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Upload Excel Report</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="upload-area" id="forecast_upload_area" style="max-width: 300px; min-height: 120px;">
                                <div class="upload-prompt">
                                    <i class="fas fa-file-excel fa-2x mb-2"></i>
                                    <p class="mb-1">Drag and drop file here or click to browse</p>
                                    <p class="text-muted small mb-0">Limit 200MB  XLS, XLSX</p>
                                </div>
                                <input type="file" id="forecast_file_input" class="d-none" accept=".xls,.xlsx">
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div id="forecast_file_info" class="d-none">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="fas fa-file-excel text-success me-2"></i>
                                    <span id="forecast_filename">No file selected</span>
                                    <button id="forecast_remove_file" class="btn btn-sm btn-link text-danger ms-auto">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tabs for different forecasting operations -->
            <ul class="nav nav-tabs mb-4" id="forecastingTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="recent-data-tab" data-bs-toggle="tab" data-bs-target="#recent-data" type="button" role="tab" aria-controls="recent-data" aria-selected="true">
                        <i class="fas fa-history"></i> Recent Data
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="evaluation-tab" data-bs-toggle="tab" data-bs-target="#evaluation" type="button" role="tab" aria-controls="evaluation" aria-selected="false">
                        <i class="fas fa-chart-bar"></i> Evaluation
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="prediction-tab" data-bs-toggle="tab" data-bs-target="#prediction" type="button" role="tab" aria-controls="prediction" aria-selected="false">
                        <i class="fas fa-chart-line"></i> Prediction
                    </button>
                </li>
            </ul>
            
            <!-- Tab content -->
            <div class="tab-content" id="forecastingTabsContent">
                <!-- Recent Data Tab -->
                <div class="tab-pane fade show active" id="recent-data" role="tabpanel" aria-labelledby="recent-data-tab">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Recent System Direction Data</h5>
                            <div>
                                <div class="input-group">
                                    <span class="input-group-text">Hours</span>
                                    <input type="number" id="recent_hours" class="form-control" value="24" min="1" max="168">
                                    <button id="load_recent_data" class="btn btn-primary">
                                        <span class="button-content">Load Data</span>
                                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="recent_data_chart" style="height: 500px;"></div>
                            <div id="recent_data_table_container"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Evaluation Tab -->
                <div class="tab-pane fade" id="evaluation" role="tabpanel" aria-labelledby="evaluation-tab">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Model Evaluation</h5>
                            <div>
                                <div class="input-group">
                                    <label class="input-group-text" for="eval_model">Model</label>
                                    <select class="form-select" id="eval_model">
                                        <option value="Best Model">Best Model</option>
                                        <option value="Prophet">Prophet</option>
                                        <option value="LinearRegression">Linear Regression</option>
                                        <option value="XGBoost">XGBoost</option>
                                        <option value="LightGBM">LightGBM</option>
                                        <option value="CatBoost">CatBoost</option>
                                    </select>
                                    <label class="input-group-text" for="eval_forecast_period">Hours</label>
                                    <input type="number" id="eval_forecast_period" class="form-control" value="168" min="1" max="720">
                                    <button id="run_evaluation" class="btn btn-primary">
                                        <span class="button-content">Evaluate</span>
                                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="evaluation_results" class="mb-4 d-none">
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Model Performance</h6>
                                            </div>
                                            <div class="card-body">
                                                <table class="table table-sm">
                                                    <tbody>
                                                        <tr>
                                                            <th style="width: 120px;" class="text-dark">Model</th>
                                                            <td id="eval_model_name" class="text-dark">-</td>
                                                        </tr>
                                                        <tr>
                                                            <th class="text-dark">MAE</th>
                                                            <td id="eval_mae" class="text-dark">-</td>
                                                        </tr>
                                                        <tr>
                                                            <th class="text-dark">R</th>
                                                            <td id="eval_r2" class="text-dark">-</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="evaluation_chart" style="height: 500px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Prediction Tab -->
                <div class="tab-pane fade" id="prediction" role="tabpanel" aria-labelledby="prediction-tab">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Forecast</h5>
                            <div>
                                <div class="input-group">
                                    <label class="input-group-text" for="forecast_model">Model</label>
                                    <select class="form-select" id="forecast_model">
                                        <option value="Best Model">Best Model</option>
                                        <option value="Prophet">Prophet</option>
                                        <option value="LinearRegression">Linear Regression</option>
                                        <option value="XGBoost">XGBoost</option>
                                        <option value="LightGBM">LightGBM</option>
                                        <option value="CatBoost">CatBoost</option>
                                    </select>
                                    <label class="input-group-text" for="forecast_period">Hours</label>
                                    <input type="number" id="forecast_period" class="form-control" value="24" min="1" max="168">
                                    <button id="run_forecast" class="btn btn-primary">
                                        <span class="button-content">Predict</span>
                                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="forecast_chart" style="height: 500px;"></div>
                            <div class="text-center mt-3">
                                <button id="download_forecast" class="btn btn-success" disabled>
                                    <i class="fas fa-download"></i> Download Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this after the forecasting section -->
    <div class="content-section" data-section="forecast-performance">
        <div class="container-fluid">
            <h2 class="mb-4">Forecast Performance Analysis</h2>
            
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle"></i> This analysis compares different forecasting models against realized prices.
            </div>
            
            <!-- Controls Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0">Performance Analysis Controls</h5>
                        </div>
                        <div class="col-md-6 text-end">
                            <button id="load_forecast_performance" class="btn btn-primary">
                                <span class="button-content">
                                    Load Performance Data
                                </span>
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            </button>
                            <button id="download_performance_chart" class="btn btn-outline-success" disabled>
                                <i class="fas fa-download"></i> Download Chart
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Forecast Horizon Selection -->
                        <div class="col-md-3">
                            <label class="form-label">Forecast Horizon</label>
                            <select id="forecast_horizon" class="form-select">
                                <option value="d+1" selected>D+1 Forecast</option>
                                <option value="d+2">D+2 Forecast</option>
                            </select>
                        </div>
                        
                        <!-- Date Selection Options -->
                        <div class="col-md-3">
                            <label class="form-label">Analysis Period</label>
                            <select id="performance_period" class="form-select">
                                <option value="7" selected>Last 7 Days</option>
                                <option value="14">Last 14 Days</option>
                                <option value="30">Last 30 Days</option>
                                <option value="60">Last 60 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="custom">Custom Date Range</option>
                            </select>
                        </div>
                        
                        <!-- Custom Date Range (initially hidden) -->
                        <div class="col-md-3" id="custom_date_range" style="display: none;">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="performance_start_date" class="form-control">
                        </div>
                        <div class="col-md-3" id="custom_date_range_end" style="display: none;">
                            <label class="form-label">End Date</label>
                            <input type="date" id="performance_end_date" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Chart Container (moved to top) -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i> 
                        Forecast Performance Chart 
                    </h5>
                </div>
                <div class="card-body">
                    <div id="forecast_performance_chart" style="height: 600px; width: 100%;"></div>
                    
                    <!-- Loading Indicator -->
                    <div id="performance_loading" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading performance data...</p>
                    </div>
                </div>
            </div>
            
            <!-- Performance Metrics Cards (moved below chart) -->
            <div id="performance_metrics" class="row" style="display: none;">
                <div class="col-12 mb-3">
                    <h5><i class="fas fa-chart-bar"></i> Performance Metrics Summary</h5>
                    <p class="text-muted">Lower WMAPE and RMSE values indicate better performance. Higher R values (closer to 1) indicate better fit.</p>
                </div>
                
                <!-- Single row container for horizontal display -->
                <div class="col-12">
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-5 g-3">
                        <div class="col">
                            <div class="card border-primary shadow-sm h-100" style="border-color: #e3f2fd !important;">
                                <div class="card-header bg-gradient text-black" style="background: linear-gradient(135deg, #64b5f6, #42a5f5); border-bottom: 1px solid #e3f2fd;">
                                    <h6 class="mb-0 text-center">
                                        <i class="fas fa-chart-line"></i> Meteologica Min
                                    </h6>
                                </div>
                                <div class="card-body p-2">
                                    <div class="row text-center g-1">
                                        <div class="col-4">
                                            <small class="text-muted d-block mb-1">WMAPE</small>
                                            <span id="meteologica_min_wmape" class="badge d-inline-block" style="background: linear-gradient(135deg, #90caf9, #64b5f6); color: white; font-size: 0.85rem; max-width: 100%; word-break: break-word; white-space: normal; padding: 0.35em 0.65em;">-</span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted d-block mb-1">RMSE</small>
                                            <span id="meteologica_min_rmse" class="badge d-inline-block" style="background: linear-gradient(135deg, #90caf9, #64b5f6); color: white; font-size: 0.8rem; max-width: 100%; word-break: break-word; white-space: normal; padding: 0.35em 0.65em;">-</span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted d-block mb-1">R</small>
                                            <span id="meteologica_min_r2" class="badge d-inline-block" style="background: linear-gradient(135deg, #90caf9, #64b5f6); color: white; font-size: 0.85rem; max-width: 100%; word-break: break-word; white-space: normal; padding: 0.35em 0.65em;">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div class="card border-info shadow-sm h-100" style="border-color: #e0f7fa !important;">
                                <div class="card-header bg-gradient text-black" style="background: linear-gradient(135deg, #4dd0e1, #26c6da); border-bottom: 1px solid #e0f7fa;">
                                    <h6 class="mb-0 text-center">
                                        <i class="fas fa-chart-area"></i> Meteologica Avg
                                    </h6>
                                </div>
                                <div class="card-body p-2">
                                    <div class="row text-center g-1">
                                        <div class="col-4">
                                            <small class="text-muted d-block mb-1">WMAPE</small>
                                            <span id="meteologica_avg_wmape" class="badge d-inline-block" style="background: linear-gradient(135deg, #80deea, #4dd0e1); color: white; font-size: 0.85rem; max-width: 100%; word-break: break-word; white-space: normal; padding: 0.35em 0.65em;">-</span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted d-block mb-1">RMSE</small>
                                            <span id="meteologica_avg_rmse" class="badge d-inline-block" style="background: linear-gradient(135deg, #80deea, #4dd0e1); color: white; font-size: 0.8rem; max-width: 100%; word-break: break-word; white-space: normal; padding: 0.35em 0.65em;">-</span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted d-block mb-1">R</small>
                                            <span id="meteologica_avg_r2" class="badge d-inline-block" style="background: linear-gradient(135deg, #80deea, #4dd0e1); color: white; font-size: 0.85rem; max-width: 100%; word-break: break-word; white-space: normal; padding: 0.35em 0.65em;">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div class="card border-secondary shadow-sm h-100" style="border-color: #f5f5f5 !important;">
                                <div class="card-header bg-gradient text-black" style="background: linear-gradient(135deg, #90a4ae, #78909c); border-bottom: 1px solid #f5f5f5;">
                                    <h6 class="mb-0 text-center">
                                        <i class="fas fa-chart-bar"></i> Meteologica Max
                                    </h6>
                                </div>
                                <div class="card-body p-2">
                                    <div class="row text-center g-1">
                                        <div class="col-4">
                                            <small class="text-muted d-block mb-1">WMAPE</small>
                                            <span id="meteologica_max_wmape" class="badge d-inline-block" style="background: linear-gradient(135deg, #b0bec5, #90a4ae); color: white; font-size: 0.85rem; max-width: 100%; word-break: break-word; white-space: normal; padding: 0.35em 0.65em;">-</span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted d-block mb-1">RMSE</small>
                                            <span id="meteologica_max_rmse" class="badge d-inline-block" style="background: linear-gradient(135deg, #b0bec5, #90a4ae); color: white; font-size: 0.8rem; max-width: 100%; word-break: break-word; white-space: normal; padding: 0.35em 0.65em;">-</span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted d-block mb-1">R</small>
                                            <span id="meteologica_max_r2" class="badge d-inline-block" style="background: linear-gradient(135deg, #b0bec5, #90a4ae); color: white; font-size: 0.85rem; max-width: 100%; word-break: break-word; white-space: normal; padding: 0.35em 0.65em;">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div class="card border-success shadow-sm h-100" style="border-color: #e8f5e8 !important;">
                                <div class="card-header bg-gradient text-black" style="background: linear-gradient(135deg, #81c784, #66bb6a); border-bottom: 1px solid #e8f5e8;">
                                    <h6 class="mb-0 text-center">
                                        <i class="fas fa-robot"></i> Model Forecast
                                    </h6>
                                </div>
                                <div class="card-body p-2">
                                    <div class="row text-center g-1">
                                        <div class="col-4">
                                            <small class="text-muted d-block mb-1">WMAPE</small>
                                            <span id="model_forecast_wmape" class="badge d-inline-block" style="background: linear-gradient(135deg, #a5d6a7, #81c784); color: white; font-size: 0.85rem; max-width: 100%; word-break: break-word; white-space: normal; padding: 0.35em 0.65em;">-</span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted d-block mb-1">RMSE</small>
                                            <span id="model_forecast_rmse" class="badge d-inline-block" style="background: linear-gradient(135deg, #a5d6a7, #81c784); color: white; font-size: 0.8rem; max-width: 100%; word-break: break-word; white-space: normal; padding: 0.35em 0.65em;">-</span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted d-block mb-1">R</small>
                                            <span id="model_forecast_r2" class="badge d-inline-block" style="background: linear-gradient(135deg, #a5d6a7, #81c784); color: white; font-size: 0.85rem; max-width: 100%; word-break: break-word; white-space: normal; padding: 0.35em 0.65em;">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div class="card border-warning shadow-sm h-100" style="border-color: #fff3cd !important;">
                                <div class="card-header bg-gradient text-black" style="background: linear-gradient(135deg, #ffb74d, #ffa726); border-bottom: 1px solid #fff3cd;">
                                    <h6 class="mb-0 text-center">
                                        <i class="fas fa-chart-pie"></i> Cemre Forecast
                                    </h6>
                                </div>
                                <div class="card-body p-2">
                                    <div class="row text-center g-1">
                                        <div class="col-4">
                                            <small class="text-muted d-block mb-1">WMAPE</small>
                                            <span id="cemre_forecast_wmape" class="badge d-inline-block" style="background: linear-gradient(135deg, #ffcc80, #ffb74d); color: white; font-size: 0.85rem; max-width: 100%; word-break: break-word; white-space: normal; padding: 0.35em 0.65em;">-</span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted d-block mb-1">RMSE</small>
                                            <span id="cemre_forecast_rmse" class="badge d-inline-block" style="background: linear-gradient(135deg, #ffcc80, #ffb74d); color: white; font-size: 0.8rem; max-width: 100%; word-break: break-word; white-space: normal; padding: 0.35em 0.65em;">-</span>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted d-block mb-1">R</small>
                                            <span id="cemre_forecast_r2" class="badge d-inline-block" style="background: linear-gradient(135deg, #ffcc80, #ffb74d); color: white; font-size: 0.85rem; max-width: 100%; word-break: break-word; white-space: normal; padding: 0.35em 0.65em;">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Combined: Gas Consumption & GM -->
    <div class="content-section" data-section="gas-gm">
        <div class="container-fluid">
            <!-- Reminder Alert -->
            <div class="alert alert-info mb-4" role="alert" style="font-family: 'RWE Sans Web'; background-color: #e8f4f8; border-color: #b8daff; color: #004085;">
                <h5 class="alert-heading" style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.5rem;">REMINDER:</h5>
                <ul class="mb-0" style="padding-left: 1.2rem;">
                    <li class="mb-1">The MCP forecasts for the first 14 days were obtained from the Meteologica XTraders service, while the forecasts for the remaining days were obtained from an internally developed model.</li>
                    <li class="mb-1">The interest income to be earned was calculated by weighting each day according to its distance from the interest date.</li>
                    <li>The Interest Consumption written next to the heading indicates the additional gas consumption expected due to interest prices, while Interest Revenue indicates the additional revenue expected to be obtained as a result of total gas consumption.</li>
                </ul>
            </div>
            <div class="row gy-2">
                <div class="col-12 ata-embed">
                    <h2 class="mb-3">Gas Consumption</h2>
                    <div class="card">
                        <div class="card-body">
                            <iframe class="ata-iframe" src="{{ url_for('static', filename='ata_htmls/mtd_gc.html') }}"></iframe>
                        </div>
                    </div>
                </div>
                <div class="col-12 ata-embed">
                    <h2 class="mb-3 mt-0">Gross Margin</h2>
                    <div class="card">
                        <div class="card-body">
                            <iframe class="ata-iframe" src="{{ url_for('static', filename='ata_htmls/mtd_gm.html') }}"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Databricks Dashboard Test -->
    <div class="content-section" data-section="databricks-test">
        <div class="container-fluid">
            <h2 class="mb-3">Databricks Dashboard Test</h2>
            <div class="card">
                <div class="card-body">
                    <div style="position: relative; width: 100%;">
                        <button
                            id="databricks-fullscreen-btn"
                            title="Fullscreen Databricks Dashboard"
                            style="position: absolute; top: 12px; right: 18px; z-index: 10; background: #fff; border-radius: 5px; border: 1px solid #bbb; padding: 6px 12px; cursor: pointer; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);"
                        >
                            <i class="fas fa-expand"></i> Fullscreen
                        </button>
                        <iframe
                            id="databricks-dashboard-iframe"
                            src="https://dbc-6991d07f-d61a.cloud.databricks.com/embed/dashboardsv3/01f0d67086391fc7add5f3a675647aab?o=1315124611400916"
                            width="100%"
                            height="800"
                            frameborder="0"
                            allowfullscreen
                            style="border: none;"
                        ></iframe>
                    </div>
                    <script>
                        // Add fullscreen functionality
                        document.getElementById('databricks-fullscreen-btn').addEventListener('click', function() {
                            const iframe = document.getElementById('databricks-dashboard-iframe');
                            if (iframe.requestFullscreen) {
                                iframe.requestFullscreen();
                            } else if (iframe.webkitRequestFullscreen) { /* Safari */
                                iframe.webkitRequestFullscreen();
                            } else if (iframe.msRequestFullscreen) { /* IE11 */
                                iframe.msRequestFullscreen();
                            }
                        });
                    </script>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}
{% block page_scripts %}
<!-- First load external libraries -->
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

<!-- Then load our application script -->
<script type="module">
  // Pass endpoints data directly as a JavaScript object
  const endpointsData = {{urls|tojson|safe}};

  import app from '{{url_for("static", filename="js/app.js")}}';

  // Initialize app with endpoints
  window.app = app;
  window.app.endpoints = endpointsData;
  
  // Add event listener for the update database button
  document.getElementById('update-rolling-database').addEventListener('click', updateRollingDatabase);
</script>

<script>
  function toggleAllOptions(selectId, checked) {
    const select = document.getElementById(selectId);
    Array.from(select.options).forEach((option) => {
      option.selected = checked;
    });
  }

  function filterOptions(selectId, searchText) {
    const select = document.getElementById(selectId);
    Array.from(select.options).forEach((option) => {
      const text = option.text.toLowerCase();
      const value = option.value.toLowerCase();
      const title = option.title ? option.title.toLowerCase() : "";
      const searchLower = searchText.toLowerCase();

      if (
        text.includes(searchLower) ||
        value.includes(searchLower) ||
        title.includes(searchLower)
      ) {
        option.style.display = "";
      } else {
        option.style.display = "none";
      }
    });
  }

  // Add checkbox to each option
  function addCheckboxesToOptions() {
    const selects = ["org_select", "adi_select", "powerplant_select"];
    selects.forEach((selectId) => {
      const select = document.getElementById(selectId);
      Array.from(select.options).forEach((option) => {
        if (!option.getAttribute("data-checkbox-added")) {
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "option-checkbox";
          checkbox.style.marginRight = "5px";
          option.prepend(checkbox);
          option.setAttribute("data-checkbox-added", "true");
        }
      });
    });
  }

  // Call this function when the page loads
  document.addEventListener("DOMContentLoaded", addCheckboxesToOptions);
</script>

<!-- Add the rolling averages script -->
<script>
// Add this debounce function at the top of your script
function debounce(func, wait) {
    let timeout;
    return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
    };
}

// Add a flag to track if charts are already loaded
let chartsLoaded = false;
// Add a flag to track if we're currently fetching last update info
let fetchingLastUpdate = false;

function loadRollingCharts() {
    // Prevent multiple loads
    if (chartsLoaded) {
        console.log("Charts already loaded, skipping");
        return;
    }
    
    // Show loading indicator
    const loadingDiv = document.getElementById('loading');
    loadingDiv.style.display = 'block';
    
    // Clear any existing charts
    const chartsContainer = document.getElementById('charts-container');
    chartsContainer.innerHTML = '';
    
    // Toggle button state
    toggleButtonLoading('load-rolling-charts', true);
    
    // Hide any previous status messages
    document.getElementById('status-message').style.display = 'none';
    
    // Get data and render charts directly without complex font loading
    fetch('{{ url_for("main.get_rolling_data") }}')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(rollingData => {
            if (rollingData.error) {
                throw new Error(rollingData.error);
            }
            
            // Store data globally for access
            window.rollingData = rollingData;
            
            // Render the charts
            renderCharts();
            
            // Set the loaded flag
            chartsLoaded = true;
            
            // Hide loading indicator when done
            loadingDiv.style.display = 'none';
            
            // Reset button state
            toggleButtonLoading('load-rolling-charts', false);
            
            // Add a single global resize handler
            if (!window.chartResizeHandlerAdded) {
                window.addEventListener('resize', debounce(function() {
                    const charts = document.querySelectorAll('.chart-container');
                    charts.forEach(chart => {
                        if (chart.id && window.Plotly) {
                            Plotly.Plots.resize(chart);
                        }
                    });
                }, 250)); // 250ms debounce
                
                window.chartResizeHandlerAdded = true;
            }
        })
        .catch(error => {
            console.error('Error fetching rolling data:', error);
            showStatusMessage('Error loading charts: ' + error.message, 'danger');
            loadingDiv.style.display = 'none';
            toggleButtonLoading('load-rolling-charts', false);
            chartsLoaded = false;
        });
}

// Debounced version of fetchLastUpdateInfo to prevent multiple calls
const debouncedFetchLastUpdateInfo = debounce(function() {
    // Check if already fetching
    if (fetchingLastUpdate) {
        console.log("Already fetching last update info, skipping");
        return;
    }
    
    console.log("Fetching last update info");
    fetchingLastUpdate = true;
    
    fetch('{{ url_for("main.get_rolling_last_update") }}')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const infoSpan = document.getElementById('last-update-info');
            if (data.last_update) {
                infoSpan.textContent = `Last updated: ${data.last_update}`;
            } else {
                infoSpan.textContent = 'No update history found';
            }
            fetchingLastUpdate = false;
        })
        .catch(error => {
            console.error('Error fetching last update info:', error);
            fetchingLastUpdate = false;
        });
}, 500); // Increase debounce time to 500ms

// Track if controls are already set up
let controlsSetup = false;

function setupRollingAveragesControls() {
    // Skip if already set up
    if (controlsSetup) {
        console.log("Controls already set up, skipping");
        return;
    }
    
    // Load charts button
    const loadChartsBtn = document.getElementById('load-rolling-charts');
    if (loadChartsBtn) {
        // Clear any existing listeners by cloning and replacing
        const newLoadBtn = loadChartsBtn.cloneNode(true);
        loadChartsBtn.parentNode.replaceChild(newLoadBtn, loadChartsBtn);
        
        // Add new event listener
        newLoadBtn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent event bubbling
            if (!chartsLoaded) {
                loadRollingCharts();
            } else {
                console.log("Charts already loaded");
            }
        });
    }
    
    // Update database button
    const updateDbBtn = document.getElementById('update-rolling-database');
    if (updateDbBtn) {
        // Clear any existing listeners by cloning and replacing
        const newUpdateBtn = updateDbBtn.cloneNode(true);
        updateDbBtn.parentNode.replaceChild(newUpdateBtn, updateDbBtn);
        
        // Add new event listener
        newUpdateBtn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent event bubbling
            updateRollingDatabase();
        });
    }
    
    // Toggle modebar for all charts
    const toggleBtn = document.getElementById('toggle-modebar-all');
    if (toggleBtn) {
        // Clear any existing listeners by cloning and replacing
        const newToggleBtn = toggleBtn.cloneNode(true);
        toggleBtn.parentNode.replaceChild(newToggleBtn, toggleBtn);
        
        // Add new event listener
        newToggleBtn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent event bubbling
            const container = document.getElementById('charts-container');
            if (container.classList.contains('hide-modebar')) {
                container.classList.remove('hide-modebar');
                this.textContent = 'Hide All Chart Controls';
            } else {
                container.classList.add('hide-modebar');
                this.textContent = 'Show All Chart Controls';
            }
        });
    }
    
    // Mark controls as set up
    controlsSetup = true;
}

// Use a flag to prevent multiple event listeners
let sectionActivatedListenerAdded = false;

// Remove any existing listeners
document.removeEventListener('section:activated', sectionActivatedHandler);

// Define the handler function separately so we can remove it if needed
function sectionActivatedHandler(e) {
    if (e.detail.section === 'rolling-averages') {
        console.log("Rolling averages section activated");
        
        // Reset control setup flag when section is activated
        controlsSetup = false;
        
        // Get last update info (only once)
        debouncedFetchLastUpdateInfo();
        
        // Setup button handlers
        setupRollingAveragesControls();
    }
    
    if (e.detail.section !== 'rolling-averages') {
        chartsLoaded = false;
        controlsSetup = false;
    }
}

// Add the listener only once
if (!sectionActivatedListenerAdded) {
    document.addEventListener('section:activated', sectionActivatedHandler);
    sectionActivatedListenerAdded = true;
}

function updateRollingDatabase() {
    // Toggle button state
    toggleButtonLoading('update-rolling-database', true);
    
    // Show status message
    showStatusMessage('Updating database with latest production, demand, and solar data...', 'info');
    
    // First update production data
    fetch('{{ url_for("main.update_rolling_data") }}')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Show intermediate message
            showStatusMessage(`Production data updated successfully. Added ${data.records_added} new records. Updating demand data...`, 'info');
            
            // Now update demand data
            return fetch('{{ url_for("main.update_demand_data_api") }}');
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Show intermediate message
            showStatusMessage(`Demand data updated successfully. Added ${data.records_added} new records. Updating unlicensed solar data...`, 'info');
            
            // Now update unlicensed solar data
            return fetch('{{ url_for("main.update_unlicensed_solar_data") }}');
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Show intermediate message
            showStatusMessage(`Unlicensed solar data updated successfully. Added ${data.records_added} new records. Updating licensed solar data...`, 'info');
            
            // Now update licensed solar data
            return fetch('{{ url_for("main.update_licensed_solar_data") }}');
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Show intermediate message
            showStatusMessage(`Licensed solar data updated successfully. Added ${data.records_added} new records. Checking for retroactive updates...`, 'info');
            
            // Check for retroactive updates (last 15 days)
            return fetch('{{ url_for("main.check_demand_updates") }}');
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Show final success message
            showStatusMessage(`Database update complete! Updated ${data.updated_records} retroactively changed records.`, 'success');
            
            // Update last update info
            debouncedFetchLastUpdateInfo();
            
            // Reset button state
            toggleButtonLoading('update-rolling-database', false);
            
            // If charts are loaded, reload them to show new data
            if (chartsLoaded) {
                chartsLoaded = false; // Reset to force reload
                loadRollingCharts();
            }
        })
        .catch(error => {
            console.error('Error updating database:', error);
            showStatusMessage('Error updating database: ' + error.message, 'danger');
            toggleButtonLoading('update-rolling-database', false);
        });
}

function showStatusMessage(message, type) {
    const statusDiv = document.getElementById('status-message');
    statusDiv.className = `alert alert-${type}`;
    statusDiv.textContent = message;
    statusDiv.style.display = 'block';
    
    // Auto-hide success messages after 5 seconds
    if (type === 'success') {
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 5000);
    }
}

function toggleButtonLoading(buttonId, isLoading) {
    const button = document.getElementById(buttonId);
    if (!button) return;
    
    const spinner = button.querySelector('.spinner-border');
    const content = button.querySelector('.button-content');
    
    if (isLoading) {
        button.disabled = true;
        if (spinner) spinner.classList.remove('d-none');
        if (content) content.style.opacity = '0.5';
    } else {
        button.disabled = false;
        if (spinner) spinner.classList.add('d-none');
        if (content) content.style.opacity = '1';
    }
}

function renderCharts() {
    const chartsContainer = document.getElementById('charts-container');
    
    // Add 7-Day Rolling Averages title first
    const rollingTitle = document.createElement('div');
    rollingTitle.className = 'row mt-4 mb-3';
    rollingTitle.innerHTML = `
        <div class="col-12">
            <h3 class="section-title" style="color: #2c3e50; font-family: 'RWE Sans Web'; border-bottom: 2px solid #eee; padding-bottom: 10px;">
                7-Day Rolling Averages
            </h3>
        </div>
    `;
    chartsContainer.appendChild(rollingTitle);

    const rollingData = window.rollingData;
    const currentYear = new Date().getFullYear();
    
    // Filter for specific fuel types and define their display order
    const fuelTypes = [
        'naturalgas',    // CCGT
        'lignite',       // Lignite
        'wind',          // Wind
        'solar_combined', // Combined Solar (existing + unlicensed)
        'importcoal',    // HardCoal
        'importexport',  // ImportExport
        'river',         // Run of River
        'dammedhydro',   // Dam
        'renewablesratio_monthly', // Renewables/Total Ratio (Monthly)
        'consumption',    // Demand
    ];
    
    // Map column names to display names
    const typeMapping = {
        'naturalgas': 'CCGT',
        'importcoal': 'HardCoal',
        'lignite': 'Lignite',
        'wind': 'Wind',
        'solar_combined': 'Solar (Combined)',  // Update this
        'importexport': 'ImportExport',
        'river': 'Run-of-River',
        'dammedhydro': 'Dam',
        'renewablesratio_monthly': 'Renewables/Total Generation Ratio',
        'consumption': 'Electricity Demand',
    };
    
    // Process each fuel type in the specified order
    let rowDiv; // Declare rowDiv outside the loop
    fuelTypes.forEach((type, index) => {
        if (!rollingData[type]) {
            console.warn(`No data found for ${type}`);
            return; // Skip if no data
        }
        
        // Create column for chart
        if (index % 2 === 0) {
            // Start a new row for every 2 charts
            rowDiv = document.createElement('div');
            rowDiv.className = 'row mb-4';
            chartsContainer.appendChild(rowDiv);
        }
        
        // Create column
        const colDiv = document.createElement('div');
        colDiv.className = 'col-md-6';
        rowDiv.appendChild(colDiv);
        
        // Create chart container
        const chartDiv = document.createElement('div');
        chartDiv.className = 'chart-container';
        chartDiv.id = `chart-${type}`;
        colDiv.appendChild(chartDiv);
        
        // Get data for this fuel type
        const data = rollingData[type];
        const traces = [];
        
        // Check for metadata FIRST, before using it
        let dateRange;
        
        // Special handling for solar_combined and renewables charts that use combined solar data
        if (type === 'solar_combined' || type === 'renewablesratio_monthly') {
            const solarMetadata = rollingData._solar_combined_metadata || {};
            dateRange = solarMetadata.date_range || '2020-2025';
        } else {
            // Use general metadata for all other charts
            const metadata = rollingData._metadata || { date_range: '2016-2025' };
            dateRange = metadata.date_range;
        }
        
        // Add historical range area
        if (data.historical_range) {
            const rangeData = data.historical_range;
            
            // Use different x values for monthly data
            let x;
            if (type === 'renewablesratio_monthly') {
                x = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]; // Month numbers
            } else {
                x = Array.from({length: rangeData.length}, (_, i) => i);
            }
            
            // Calculate min and max values for the legend
            const maxValue = Math.max(...rangeData.map(d => d ? d.max : 0).filter(v => v !== null));
            const minValue = Math.min(...rangeData.map(d => d ? d.min : 0).filter(v => v !== null));
            
            // Format the values based on chart type
            let rangeLabel;
            if (type === 'renewablesratio_monthly') {
                // Format as percentage for renewables ratio
                const minPercent = (minValue * 100).toFixed(0);
                const maxPercent = (maxValue * 100).toFixed(0);
                rangeLabel = `${minPercent}%-${maxPercent}%`;
            } else {
                // Format with thousands separator for other types
                const formatter = new Intl.NumberFormat('en-US');
                rangeLabel = `${formatter.format(Math.round(minValue))}-${formatter.format(Math.round(maxValue))} MWh`;
            }
            
            // Create the range area with dynamic date range
            traces.push({
                name: `${dateRange}`,
                x: x.concat(x.slice().reverse()),
                y: rangeData.map(d => d ? d.max : null).concat(rangeData.map(d => d ? d.min : null).reverse()),
                fill: 'toself',
                type: 'scatter',
                mode: 'none',
                fillcolor: 'rgba(135, 206, 250, 0.4)',
                line: {color: 'transparent', width: 0},
                showlegend: true,
                hoverinfo: 'skip',  // Skip hover information for the range area
                hoverlabel: {namelength: -1}  // Show full name in hover label
            });
        }
        
        // Add historical average
        if (data.historical_avg) {
            // Use different x values for monthly data
            let x;
            if (type === 'renewablesratio_monthly') {
                x = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]; // Month numbers
            } else {
                x = Array.from({length: data.historical_avg.length}, (_, i) => i);
            }
            
            traces.push({
                name: `${dateRange} avg.`,
                x: x,
                y: data.historical_avg,
                type: 'scatter',
                mode: 'lines',
                line: {
                    color: 'rgba(0, 0, 255, 0.8)',
                    width: 1.5,
                    dash: '3,3'
                }
            });
        }
        
        // Add 2025 (previous year - shown as solid black line)
        if (data[currentYear - 1]) {
            // Use different x values for monthly data
            let x;
            if (type === 'renewablesratio_monthly') {
                x = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]; // Month numbers
            } else {
                x = Array.from({length: data[currentYear - 1].length}, (_, i) => i);
            }
            
            traces.push({
                name: (currentYear - 1).toString(),
                x: x,
                y: data[currentYear - 1],
                type: 'scatter',
                mode: 'lines',
                line: {
                    color: 'black',
                    width: 2.5
                }
            });
        }
        
        // Add 2026 (current year - shown as solid red line)
        if (data[currentYear]) {
            // Use different x values for monthly data
            let x;
            if (type === 'renewablesratio_monthly') {
                x = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]; // Month numbers
            } else {
                x = Array.from({length: data[currentYear].length}, (_, i) => i);
            }
            
            traces.push({
                name: currentYear.toString(),
                x: x,
                y: data[currentYear],
                type: 'scatter',
                mode: 'lines',
                line: {
                    color: 'red',
                    width: 2.5
                }
            });
        }
        
        // Get display name for the fuel type
        let displayType = typeMapping[type] || type;
        
        // Special handling for renewables ratio
        let yaxisFormat = ',d';
        let yaxisTitle = 'mW';
        let chartTitle = `TR 7-Day Rolling ${displayType} Generation - mW`;
        let xaxisTicktext = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                             'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        let xaxisTickvals = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];

        if (type === 'renewablesratio_monthly') {
            yaxisFormat = '.0%';  // Format as percentage
            yaxisTitle = '';  // Percentage label for renewables ratio
            chartTitle = `${displayType}`;  // No need for "Generation - MWh" suffix
            xaxisTickvals = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]; // Month numbers
        }
        
        const layout = {
            title: {
                text: chartTitle,
                font: {
                    family: 'RWE Sans Web',
                    size: 22,
                    color: '#333333'
                },
                x: 0.127,
                y: 0.95,
                xanchor: 'left',
                yanchor: 'top'
            },
            xaxis: {
                ticktext: xaxisTicktext,
                tickvals: xaxisTickvals,
                showgrid: true,
                gridcolor: 'rgba(0,0,0,0.2)',
                tickfont: {
                    family: 'RWE Sans Web',
                    size: 14,
                    color: '#333333'
                },
                linecolor: 'black',
                linewidth: 1,
                mirror: true,
                zeroline: true,
                zerolinecolor: 'rgba(0,0,0,0.2)',
                zerolinewidth: 1
            },
            yaxis: {
                showgrid: true,
                gridcolor: 'rgba(0,0,0,0.2)',
                tickfont: {
                    family: 'RWE Sans Web',
                    size: 14,
                    color: '#333333'
                },
                exponentformat: 'none',
                separatethousands: true,
                rangemode: 'normal',
                autorange: true,
                tickformat: yaxisFormat,
                title: yaxisTitle,
                linecolor: 'black',
                linewidth: 1,
                mirror: true,
                zeroline: true,
                zerolinecolor: 'rgba(0,0,0,0.2)',
                zerolinewidth: 1
            },
            showlegend: true,
            legend: {
                orientation: 'v',
                y: 1,
                x: 1,
                xanchor: 'right',
                yanchor: 'top',
                bgcolor: 'rgba(255, 255, 255, 0.9)',
                bordercolor: 'rgba(0, 0, 0, 0.2)',
                borderwidth: 1,
                font: {
                    family: 'RWE Sans Web',
                    size: 12,
                    color: '#333333'
                },
                traceorder: 'reversed'
            },
            margin: {
                l: 70,
                r: 20,
                t: 60,
                b: 50
            },
            autosize: false,
            height: 480,
            hovermode: 'x unified',
            plot_bgcolor: 'white',
            paper_bgcolor: 'white',
            font: {
                family: 'RWE Sans Web'
            },
            shapes: [{
                type: 'rect',
                xref: 'paper',
                yref: 'paper',
                x0: 0,
                y0: 0,
                x1: 1,
                y1: 1,
                line: {
                    color: 'black',
                    width: 1
                },
                layer: 'below'
            }]
        };
        
        // Add this to the layout object
        layout.hovermode = 'closest';
        layout.hoverlabel = {
            namelength: -1,  // Show full trace name
            font: {
                family: 'RWE Sans Web',
                size: 12
            }
        };

        // Modify the range trace to use custom hover template
        traces[0].hovertemplate = '%{y:,.0f} MWh<extra></extra>';
        
        // Modify all traces to use custom hover templates with proper date formatting
        traces.forEach((trace, i) => {
            if (i === 0) {
                // For the range area, we already set hoverinfo: 'skip'
                return;
            }
            
            // For time series data, create a custom hover template with formatted dates
            if (type === 'renewablesratio_monthly') {
                // For monthly data, show month names
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
                trace.hovertemplate = 
                    '<b>%{data.name}</b><br>' +
                    '%{x|%B}: %{y:,.0f} MWh<extra></extra>';
            } else {
                // For daily data, format as proper dates
                trace.hovertemplate = 
                    '<b>%{data.name}</b><br>' +
                    '%{text}: %{y:,.0f} MWh<extra></extra>';
                
                // Add formatted dates as text array
                const dateTexts = [];
                for (let i = 0; i < trace.x.length; i++) {
                    const dayOfYear = trace.x[i];
                    const date = new Date(currentYear, 0, dayOfYear + 1); // +1 because day of year is 0-indexed
                    dateTexts.push(date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
                }
                trace.text = dateTexts;
            }
        });
        
        Plotly.newPlot(chartDiv, traces, layout, {
            displayModeBar: true,
            responsive: true,
            modeBarButtonsToRemove: ['select2d', 'lasso2d', 'autoScale2d'],
            toImageButtonOptions: {
                format: 'png',
                filename: `TR_7Day_Rolling_${displayType}`,
                height: 600,
                width: 800,
                scale: 2,
                bgcolor: 'white',
                font: {
                    family: 'RWE Sans Web'
                }
            }
        });
        
        // IMPORTANT: Remove the individual resize handlers from each chart
        // Delete these lines from your existing code:
        // window.addEventListener('resize', function() {
        //     Plotly.Plots.resize(chartDiv);
        // });
    });
}

// Fallback in case fonts.ready doesn't work
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        if (!document.fonts.check('12px "RWE Sans Web"')) {
            console.log("Font not loaded yet, using fallback");
            // Only initialize if we're on the rolling-averages section
            if (document.querySelector('.content-section[data-section="rolling-averages"]').style.display !== 'none') {
                setupRollingAveragesControls();
            }
        }
    }, 1000);
});

// Reset charts when leaving the section
document.addEventListener('section:activated', function(e) {
    if (e.detail.section !== 'rolling-averages') {
        chartsLoaded = false;
    }
});

function createDemandChartsRow() {
    const chartsContainer = document.getElementById('charts-container');
    if (!chartsContainer) {
        console.error('Charts container not found');
        return;
    }
    
    // Check if Demand title already exists
    const existingDemandTitle = Array.from(document.querySelectorAll('.section-title'))
        .find(el => el.textContent.trim() === 'Average Demand');
    
    if (!existingDemandTitle) {
        const sectionDivider = document.createElement('div');
        sectionDivider.className = 'row mt-4 mb-3';
        sectionDivider.innerHTML = `
            <div class="col-12">
                <h3 class="section-title" style="color: #2c3e50; font-family: 'RWE Sans Web'; border-bottom: 2px solid #eee; padding-bottom: 10px;">
                    Average Demand
                </h3>
            </div>
        `;
        chartsContainer.appendChild(sectionDivider);
    }
    
    // Create a dedicated row for demand charts
    const demandChartsRow = document.createElement('div');
    demandChartsRow.className = 'row mb-4';
    demandChartsRow.id = 'demand-charts-row';
    chartsContainer.appendChild(demandChartsRow);
}

function renderDemandChart() {
    // Create demand chart container if it doesn't exist
    let chartDiv = document.getElementById('demand-chart');
    if (!chartDiv) {
        const demandChartsRow = document.getElementById('demand-charts-row');
        if (!demandChartsRow) {
            console.error('Demand charts row not found');
            return;
        }
        
        const chartContainer = document.createElement('div');
        chartContainer.className = 'col-md-6';
        chartContainer.innerHTML = `
            <div class="chart-container" id="demand-chart"></div>
        `;
        
        demandChartsRow.appendChild(chartContainer);
        chartDiv = document.getElementById('demand-chart');
    }

    fetch('{{ url_for("main.get_demand_data") }}')
        .then(response => response.json())
        .then(data => {
            const currentYear = new Date().getFullYear();
            const previousYear = currentYear - 1;
            const traces = [];
            
            // Render MTD/YTD metrics panel
            try {
                const demandChartsRow = document.getElementById('demand-charts-row');
                if (demandChartsRow && data.metrics) {
                    let metricsCol = document.getElementById('demand-metrics-col');
                    if (!metricsCol) {
                        metricsCol = document.createElement('div');
                        metricsCol.className = 'col-12 mb-2';
                        metricsCol.id = 'demand-metrics-col';
                        // Insert metrics row before charts
                        demandChartsRow.parentNode.insertBefore(metricsCol, demandChartsRow);
                    }
                    const fmt = (n) => (n === null || n === undefined) ? '-' : Number(n).toLocaleString('en-US', { maximumFractionDigits: 0 });
                    const fmtPct = (p) => (p === null || p === undefined) ? '-' : `${(p>0?'+':'')}${Number(p).toFixed(2)}%`;
                    const m = data.metrics;
                    const monthName = (m && m.mtd && m.mtd.month_name) ? m.mtd.month_name : '';
                    const mtd = m && m.mtd ? m.mtd : null;
                    const ytd = m && m.ytd ? m.ytd : null;
                    metricsCol.innerHTML = `
                        <div class="card" style="border: 1px solid rgba(0,0,0,0.1);">
                          <div class="card-body py-2" style="font-family: 'RWE Sans Web';">
                            <div class="row text-center" style="font-size: 14px;">
                              <div class="col-md-6">
                                <div><strong>MTD (${monthName})</strong></div>
                                <div>${previousYear}: <strong>${fmt(mtd ? mtd.previous_year : null)} MWh</strong></div>
                                <div>${currentYear}: <strong>${fmt(mtd ? mtd.current_year : null)} MWh</strong></div>
                                <div>: <strong>${fmt(mtd ? mtd.diff : null)} MWh</strong> (<span style="color:${mtd && mtd.pct>=0?'#228B22':'#cc0000'};">${fmtPct(mtd ? mtd.pct : null)}</span>)</div>
                              </div>
                              <div class="col-md-6">
                                <div><strong>YTD</strong></div>
                                <div>${previousYear}: <strong>${fmt(ytd ? ytd.previous_year : null)} MWh</strong></div>
                                <div>${currentYear}: <strong>${fmt(ytd ? ytd.current_year : null)} MWh</strong></div>
                                <div>: <strong>${fmt(ytd ? ytd.diff : null)} MWh</strong> (<span style="color:${ytd && ytd.pct>=0?'#228B22':'#cc0000'};">${fmtPct(ytd ? ytd.pct : null)}</span>)</div>
                              </div>
                            </div>
                          </div>
                        </div>`;
                }
            } catch (e) {
                console.warn('Failed to render demand metrics panel', e);
            }

            // Get current date to limit the data range
            const now = new Date();
            const currentWeek = Math.ceil((now - new Date(now.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24 * 7));
            
            // Create date array for x-axis with weekly points
            const dateArray = [];
            const startDate = new Date(currentYear, 0, 1);
            for (let i = 0; i < currentWeek; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + (i * 7));
                dateArray.push(date.toISOString().split('T')[0]);
            }

            // Create tick values and labels for first day of each month
            const tickVals = [];
            const tickText = [];
            let currentMonth = -1;
            dateArray.forEach(date => {
                const d = new Date(date);
                if (d.getMonth() !== currentMonth) {
                    currentMonth = d.getMonth();
                    const firstOfMonth = new Date(d.getFullYear(), d.getMonth(), 1);
                    tickVals.push(firstOfMonth.toISOString().split('T')[0]);
                    tickText.push(firstOfMonth.toLocaleString('en-US', { month: 'short' }));
                }
            });
            
            // Add previous year data (2024) - solid blue line
            if (data.consumption && data.consumption[previousYear]) {
                const y = data.consumption[previousYear].slice(0, currentWeek);
                
                // Create an array of formatted dates with week information
                const hoverTexts = dateArray.map(dateStr => {
                    const date = new Date(dateStr);
                    const month = date.toLocaleString('en-US', { month: 'short' });
                    const weekOfMonth = Math.ceil(date.getDate() / 7);
                    return `${month} Week ${weekOfMonth}`;
                });
                
                traces.push({
                    name: previousYear.toString(),
                    x: dateArray,
                    y: y,
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: 'blue',
                        width: 2
                    },
                    text: hoverTexts,
                    hovertemplate: '<b>%{data.name}</b><br>%{text}: %{y:,.0f} MWh<extra></extra>'
                });
            }
            
            // Add current year data (2025) - solid red line
            if (data.consumption && data.consumption[currentYear]) {
                const y = data.consumption[currentYear].slice(0, currentWeek);
                
                // Create an array of formatted dates with week information
                const hoverTexts = dateArray.map(dateStr => {
                    const date = new Date(dateStr);
                    const month = date.toLocaleString('en-US', { month: 'short' });
                    const weekOfMonth = Math.ceil(date.getDate() / 7);
                    return `${month} Week ${weekOfMonth}`;
                });
                
                traces.push({
                    name: currentYear.toString(),
                    x: dateArray,
                    y: y,
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: 'red',
                        width: 2
                    },
                    text: hoverTexts,
                    hovertemplate: '<b>%{data.name}</b><br>%{text}: %{y:,.0f} MWh<extra></extra>'
                });
            }
            
            const layout = {
                title: {
                    text: 'Avg. Demand',
                    font: {
                        family: 'RWE Sans Web',
                        size: 22,
                        color: '#333333'
                    },
                    x: 0.127,
                    y: 0.95,
                    xanchor: 'left',
                    yanchor: 'top'
                },
                xaxis: {
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.2)',
                    zeroline: true,
                    zerolinecolor: 'rgba(0,0,0,0.2)',
                    zerolinewidth: 1,
                    linecolor: 'black',
                    linewidth: 1,
                    mirror: true,
                    type: 'date',
                    tickformat: '%b',
                    tickangle: 0,
                    tickmode: 'array',
                    ticktext: tickText,
                    tickvals: tickVals,
                    nticks: tickVals.length,
                    tickfont: {
                        family: 'RWE Sans Web',
                        size: 14,
                        color: '#333333'
                    }
                },
                yaxis: {
                    title: 'MWh',
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.2)',
                    zeroline: true,
                    zerolinecolor: 'rgba(0,0,0,0.2)',
                    zerolinewidth: 1,
                    linecolor: 'black',
                    linewidth: 1,
                    mirror: true,
                    tickfont: {
                        family: 'RWE Sans Web',
                        size: 14,
                        color: '#333333'
                    },
                    exponentformat: 'none',
                    separatethousands: true,
                    rangemode: 'normal',
                    autorange: true,
                    tickformat: ',d'
                },
                showlegend: true,
                legend: {
                    orientation: 'v',
                    y: 1,
                    x: 1,
                    xanchor: 'right',
                    yanchor: 'top',
                    bgcolor: 'rgba(255, 255, 255, 0.9)',
                    bordercolor: 'rgba(0, 0, 0, 0.2)',
                    borderwidth: 1,
                    font: {
                        family: 'RWE Sans Web',
                        size: 12,
                        color: '#333333'
                    },
                    traceorder: 'reversed'
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                hovermode: 'x unified',
                font: {
                    family: 'RWE Sans Web'
                },
                shapes: [{
                    type: 'rect',
                    xref: 'paper',
                    yref: 'paper',
                    x0: 0,
                    y0: 0,
                    x1: 1,
                    y1: 1,
                    line: {
                        color: 'black',
                        width: 1
                    },
                    layer: 'below'
                }],
                margin: {
                    l: 70,
                    r: 20,
                    t: 60,
                    b: 50
                },
                autosize: false,
                height: 480
            };
            
            Plotly.newPlot(chartDiv, traces, layout, {
                displayModeBar: true,
                responsive: true,
                modeBarButtonsToRemove: ['select2d', 'lasso2d', 'autoScale2d'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'TR_Average_Demand',
                    height: 600,
                    width: 800,
                    scale: 2,
                    bgcolor: 'white',
                    font: {
                        family: 'RWE Sans Web'
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error fetching demand data:', error);
            chartDiv.innerHTML = `<div class="alert alert-danger">Error loading demand data: ${error.message}</div>`;
        });
}

function renderMonthlyDemandChart() {
    // Create monthly demand chart container if it doesn't exist
    let chartDiv = document.getElementById('monthly-demand-chart');
    if (!chartDiv) {
        const demandChartsRow = document.getElementById('demand-charts-row');
        if (!demandChartsRow) {
            console.error('Demand charts row not found');
            return;
        }
        
        const chartContainer = document.createElement('div');
        chartContainer.className = 'col-md-6';
        chartContainer.innerHTML = `
            <div class="chart-container" id="monthly-demand-chart"></div>
        `;
        
        demandChartsRow.appendChild(chartContainer);
        chartDiv = document.getElementById('monthly-demand-chart');
    }

    fetch('{{ url_for("main.get_monthly_demand_data") }}')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            const currentYear = new Date().getFullYear();
            const previousYear = currentYear - 1;
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthNumbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
            
            const traces = [];
            
            // Get current month to limit display
            const currentMonth = new Date().getMonth() + 1; // 1-based month
            const displayMonths = monthNumbers.slice(0, currentMonth);
            const displayMonthNames = monthNames.slice(0, currentMonth);
            
            // Get data for both years
            const currentYearData = data.monthly_consumption[currentYear] ? data.monthly_consumption[currentYear].slice(0, currentMonth) : [];
            const previousYearData = data.monthly_consumption[previousYear] ? data.monthly_consumption[previousYear].slice(0, currentMonth) : [];
            
            // Function to find intersection point between two line segments
            function findIntersection(x1, y1, x2, y2, x3, y3, x4, y4) {
                const denom = (x1 - x2) * (y3 - y4) - (y1 - y2) * (x3 - x4);
                if (Math.abs(denom) < 1e-10) return null; // Lines are parallel
                
                const t = ((x1 - x3) * (y3 - y4) - (y1 - y3) * (x3 - x4)) / denom;
                if (t < 0 || t > 1) return null; // Intersection outside segment
                
                const x = x1 + t * (x2 - x1);
                const y = y1 + t * (y2 - y1);
                return { x, y };
            }
            
            // Function to interpolate between two points
            function interpolate(x1, y1, x2, y2, x) {
                if (Math.abs(x2 - x1) < 1e-10) return y1;
                const t = (x - x1) / (x2 - x1);
                return y1 + t * (y2 - y1);
            }
            
            // Create high-resolution fill areas with precise crossover detection
            let hasGreenLegend = false;
            let hasRedLegend = false;
            
            // For each monthly segment, create sub-segments with intersection detection
            for (let i = 0; i < currentYearData.length - 1; i++) {
                const x1 = displayMonths[i];
                const x2 = displayMonths[i + 1];
                const y1_current = currentYearData[i];     // 2025 start
                const y2_current = currentYearData[i + 1]; // 2025 end
                const y1_previous = previousYearData[i];    // 2024 start
                const y2_previous = previousYearData[i + 1]; // 2024 end
                
                // Find intersection point within this segment
                const intersection = findIntersection(x1, y1_current, x2, y2_current, x1, y1_previous, x2, y2_previous);
                
                if (intersection) {
                    // Lines cross within this segment - create two sub-segments
                    const intersectionX = intersection.x;
                    const intersectionY = intersection.y;
                    
                    // First sub-segment: from start to intersection
                    const isGreen1 = y1_current > y1_previous;
                    const fillColor1 = isGreen1 ? 
                        'rgba(34, 139, 34, 0.4)' : // Green
                        'rgba(255, 0, 0, 0.4)';    // Red
                    const traceName1 = isGreen1 ? 'Higher than 2025' : 'Lower than 2025';
                    
                    const showInLegend1 = (isGreen1 && !hasGreenLegend) || (!isGreen1 && !hasRedLegend);
                    if (isGreen1) hasGreenLegend = true;
                    if (!isGreen1) hasRedLegend = true;
                    
                    traces.push({
                        name: traceName1,
                        x: [x1, intersectionX, intersectionX, x1],
                        y: [y1_current, intersectionY, intersectionY, y1_previous],
                        fill: 'toself',
                        type: 'scatter',
                        mode: 'none',
                        fillcolor: fillColor1,
                        line: {color: 'transparent', width: 0},
                        showlegend: showInLegend1,
                        legendgroup: traceName1,
                        hoverinfo: 'skip'
                    });
                    
                    // Second sub-segment: from intersection to end
                    const isGreen2 = y2_current > y2_previous;
                    const fillColor2 = isGreen2 ? 
                        'rgba(34, 139, 34, 0.4)' : // Green
                        'rgba(255, 0, 0, 0.4)';    // Red
                    const traceName2 = isGreen2 ? 'Higher than 2025' : 'Lower than 2025';
                    
                    const showInLegend2 = (isGreen2 && !hasGreenLegend) || (!isGreen2 && !hasRedLegend);
                    if (isGreen2) hasGreenLegend = true;
                    if (!isGreen2) hasRedLegend = true;
                    
                    traces.push({
                        name: traceName2,
                        x: [intersectionX, x2, x2, intersectionX],
                        y: [intersectionY, y2_current, y2_previous, intersectionY],
                        fill: 'toself',
                        type: 'scatter',
                        mode: 'none',
                        fillcolor: fillColor2,
                        line: {color: 'transparent', width: 0},
                        showlegend: showInLegend2,
                        legendgroup: traceName2,
                        hoverinfo: 'skip'
                    });
                } else {
                    // Lines don't cross within this segment - single color for entire segment
                    const isGreen = y1_current > y1_previous; // Use start point to determine color
                    const fillColor = isGreen ? 
                        'rgba(34, 139, 34, 0.4)' : // Green
                        'rgba(255, 0, 0, 0.4)';    // Red
                    const traceName = isGreen ? 'Higher than 2025' : 'Lower than 2025';
                    
                    const showInLegend = (isGreen && !hasGreenLegend) || (!isGreen && !hasRedLegend);
                    if (isGreen) hasGreenLegend = true;
                    if (!isGreen) hasRedLegend = true;
                    
                    traces.push({
                        name: traceName,
                        x: [x1, x2, x2, x1],
                        y: [y1_current, y2_current, y2_previous, y1_previous],
                        fill: 'toself',
                        type: 'scatter',
                        mode: 'none',
                        fillcolor: fillColor,
                        line: {color: 'transparent', width: 0},
                        showlegend: showInLegend,
                        legendgroup: traceName,
                        hoverinfo: 'skip'
                    });
                }
            }
            
            // Add previous year line (2024) - blue
            if (previousYearData.length > 0) {
                traces.push({
                    name: previousYear.toString(),
                    x: displayMonths,
                    y: previousYearData,
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: 'blue',
                        width: 2
                    },
                    hovertemplate: '<b>%{data.name}</b><br>%{text}: %{y:,.0f} MWh<extra></extra>',
                    text: displayMonthNames
                });
            }
            
            // Add current year line (2025) - red
            if (currentYearData.length > 0) {
                traces.push({
                    name: currentYear.toString(),
                    x: displayMonths,
                    y: currentYearData,
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: 'red',
                        width: 2
                    },
                    hovertemplate: '<b>%{data.name}</b><br>%{text}: %{y:,.0f} MWh<extra></extra>',
                    text: displayMonthNames
                });
            }
            
            const layout = {
                title: {
                    text: 'Average Electricity Demand, Y-o-Y',
                    font: {
                        family: 'RWE Sans Web',
                        size: 22,
                        color: '#333333'
                    },
                    x: 0.127,
                    y: 0.95,
                    xanchor: 'left',
                    yanchor: 'top'
                },
                xaxis: {
                    ticktext: displayMonthNames,
                    tickvals: displayMonths,
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.2)',
                    tickfont: {
                        family: 'RWE Sans Web',
                        size: 14,
                        color: '#333333'
                    },
                    linecolor: 'black',
                    linewidth: 1,
                    mirror: true,
                    zeroline: true,
                    zerolinecolor: 'rgba(0,0,0,0.2)',
                    zerolinewidth: 1
                },
                yaxis: {
                    title: 'MWh',
                    showgrid: true,
                    gridcolor: 'rgba(0,0,0,0.2)',
                    tickfont: {
                        family: 'RWE Sans Web',
                        size: 14,
                        color: '#333333'
                    },
                    exponentformat: 'none',
                    separatethousands: true,
                    rangemode: 'normal',
                    autorange: true,
                    tickformat: ',d',
                    linecolor: 'black',
                    linewidth: 1,
                    mirror: true,
                    zeroline: true,
                    zerolinecolor: 'rgba(0,0,0,0.2)',
                    zerolinewidth: 1
                },
                showlegend: true,
                legend: {
                    orientation: 'v',
                    y: 1,
                    x: 1,
                    xanchor: 'right',
                    yanchor: 'top',
                    bgcolor: 'rgba(255, 255, 255, 0.9)',
                    bordercolor: 'rgba(0, 0, 0, 0.2)',
                    borderwidth: 1,
                    font: {
                        family: 'RWE Sans Web',
                        size: 12,
                        color: '#333333'
                    },
                    traceorder: 'reversed'
                },
                margin: {
                    l: 70,
                    r: 20,
                    t: 60,
                    b: 50
                },
                autosize: false,
                height: 480,
                hovermode: 'x unified',
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                font: {
                    family: 'RWE Sans Web'
                },
                shapes: [{
                    type: 'rect',
                    xref: 'paper',
                    yref: 'paper',
                    x0: 0,
                    y0: 0,
                    x1: 1,
                    y1: 1,
                    line: {
                        color: 'black',
                        width: 1
                    },
                    layer: 'below'
                }]
            };
            
            Plotly.newPlot(chartDiv, traces, layout, {
                displayModeBar: true,
                responsive: true,
                modeBarButtonsToRemove: ['select2d', 'lasso2d', 'autoScale2d'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'TR_Average_Electricity_Demand_YoY',
                    height: 600,
                    width: 800,
                    scale: 2,
                    bgcolor: 'white',
                    font: {
                        family: 'RWE Sans Web'
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error fetching monthly demand data:', error);
            chartDiv.innerHTML = `<div class="alert alert-danger">Error loading monthly demand data: ${error.message}</div>`;
        });
}

// Modify the loadRollingCharts function to call renderDemandChart
function loadRollingCharts() {
    // Prevent multiple loads
    if (chartsLoaded) {
        console.log("Charts already loaded, skipping");
        return;
    }
    
    // Show loading indicator
    const loadingDiv = document.getElementById('loading');
    loadingDiv.style.display = 'block';
    
    // Clear any existing charts
    const chartsContainer = document.getElementById('charts-container');
    chartsContainer.innerHTML = '';
    
    // Toggle button state
    toggleButtonLoading('load-rolling-charts', true);
    
    // Hide any previous status messages
    document.getElementById('status-message').style.display = 'none';
    
    // Get data and render charts
    fetch('{{ url_for("main.get_rolling_data") }}')
        .then(response => response.json())
        .then(rollingData => {
            if (rollingData.error) {
                throw new Error(rollingData.error);
            }
            
            // Store data globally for access
            window.rollingData = rollingData;
            
            // Render the charts
            renderCharts();
            
            // Create a dedicated row for the demand charts
            createDemandChartsRow();
            
            // Render both demand charts
            renderDemandChart();
            renderMonthlyDemandChart();
            
            // Set the loaded flag
            chartsLoaded = true;
            
            // Hide loading indicator
            loadingDiv.style.display = 'none';
            
            // Reset button state
            toggleButtonLoading('load-rolling-charts', false);
            
            // Add resize handler if not already added
            if (!window.chartResizeHandlerAdded) {
                window.addEventListener('resize', debounce(function() {
                    const charts = document.querySelectorAll('.chart-container');
                    charts.forEach(chart => {
                        if (chart.id && window.Plotly) {
                            Plotly.Plots.resize(chart);
                        }
                    });
                }, 250));
                
                window.chartResizeHandlerAdded = true;
            }
        })
        .catch(error => {
            console.error('Error fetching rolling data:', error);
            showStatusMessage('Error loading charts: ' + error.message, 'danger');
            loadingDiv.style.display = 'none';
            toggleButtonLoading('load-rolling-charts', false);
            chartsLoaded = false;
        });
}
</script>

<script>
    // Ensure the active tab is properly highlighted on page load
    document.addEventListener('DOMContentLoaded', function() {
        const hash = window.location.hash;
        if (hash) {
            const tab = document.querySelector(`#forecastingTabs .nav-link[data-bs-target="${hash}"]`);
            if (tab) {
                tab.click();
            }
        }
    });
</script>

<script>
    // Toggle legends for all charts
    const toggleLegendsBtn = document.getElementById('toggle-legends-all');
    if (toggleLegendsBtn) {
        // Clear any existing listeners by cloning and replacing
        const newToggleLegendsBtn = toggleLegendsBtn.cloneNode(true);
        toggleLegendsBtn.parentNode.replaceChild(newToggleLegendsBtn, toggleLegendsBtn);
        
        // Add new event listener
        newToggleLegendsBtn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent event bubbling
            const charts = document.querySelectorAll('.chart-container');
            let areLegendsVisible = true;
            
            // Check current state by looking at the first chart
            if (charts.length > 0) {
                const firstChart = charts[0];
                if (firstChart._fullLayout && firstChart._fullLayout.showlegend !== undefined) {
                    areLegendsVisible = firstChart._fullLayout.showlegend;
                }
            }
            
            // Toggle all chart legends
            charts.forEach(chart => {
                if (chart.id && window.Plotly && chart._fullLayout) {
                    Plotly.relayout(chart, 'showlegend', !areLegendsVisible);
                }
            });
            
            // Update button text
            this.textContent = areLegendsVisible ? 'Show All Legends' : 'Hide All Legends';
        });
    }
</script>
{% endblock page_scripts %}
